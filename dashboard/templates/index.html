<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Parsely</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2316a34a' stroke-width='1.6' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 20 C12 18 12 16 12 14 C12 12 12 10 13 8' fill='none'/%3E%3Cpath d='M12 15 C9 15 7 13 7 10 C7 7 9 5 12 6 C11 8 10 10 11 12 C12 13 13 14 12 15Z' fill='%2316a34a' stroke='none' opacity='0.9'/%3E%3Cpath d='M12 12 C15 12 17 10 17 7 C17 4 15 3 12 4 C13 6 14 8 13 10 C12 11 11 11 12 12Z' fill='%2316a34a' stroke='none' opacity='0.9'/%3E%3Cpath d='M13 8 C11 6 12 4 14 3 C15 4 15 6 13 8Z' fill='%2316a34a' stroke='none'/%3E%3Cpath d='M11 13 C9 12 9 10 10 9 C11 10 12 12 11 13Z' fill='%2316a34a' stroke='none' opacity='0.7'/%3E%3Cpath d='M13 10 C15 9 15 7 14 6 C13 7 12 9 13 10Z' fill='%2316a34a' stroke='none' opacity='0.7'/%3E%3C/svg%3E">
<style>
/* ── Reset & Variables ─────────────────────────────────────────────────── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --hdr-h:     56px;
  --side-w:    300px;
  --bg:        #f0f2f5;
  --card:      #ffffff;
  --sidebar:   #1a2035;
  --side-item: #242d47;
  --side-sel:  #2e3f6e;
  --side-hov:  #1f2d4a;
  --border:    #e2e6ea;
  --text:      #1c2533;
  --muted:     #6b7280;
  --ok:        #16a34a;
  --warn:      #d97706;
  --err:       #dc2626;
  --info:      #2563eb;
  --ok-bg:     #dcfce7;
  --warn-bg:   #fef3c7;
  --err-bg:    #fee2e2;
  --info-bg:   #dbeafe;
  --accent:    #3b5bdb;
  --exported:  #7c3aed;
  --exported-bg: #ede9fe;
  --radius:    8px;
  --shadow:    0 1px 3px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.06);
  --shadow-md: 0 4px 6px rgba(0,0,0,.07), 0 2px 4px rgba(0,0,0,.06);
}

/* Dark mode theme */
[data-theme="dark"] {
  --bg:        #0f172a;
  --card:      #1e293b;
  --sidebar:   #0f172a;
  --side-item: #1e293b;
  --side-sel:  #334155;
  --side-hov:  #2d3748;
  --border:    #334155;
  --text:      #e2e8f0;
  --muted:     #94a3b8;
  --ok-bg:     rgba(22, 163, 74, 0.2);
  --warn-bg:   rgba(217, 119, 6, 0.2);
  --err-bg:    rgba(220, 38, 38, 0.2);
  --info-bg:   rgba(37, 99, 235, 0.2);
  --shadow:    0 1px 3px rgba(0,0,0,.3), 0 1px 2px rgba(0,0,0,.2);
  --shadow-md: 0 4px 6px rgba(0,0,0,.4), 0 2px 4px rgba(0,0,0,.3);
}

/* ── Layout ────────────────────────────────────────────────────────────── */
html, body { height: 100%; }
body {
  height: 100vh;
  height: 100dvh;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  font-size: 13px;
  color: var(--text);
  background: var(--bg);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

header {
  height: var(--hdr-h);
  background: var(--card);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 20px;
  gap: 24px;
  flex-shrink: 0;
  box-shadow: var(--shadow);
  z-index: 10;
}

.app-title {
  font-size: 15px;
  font-weight: 700;
  color: #16a34a; /* Parsley green */
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 8px;
}
.app-title svg { 
  opacity: 1;
  color: #16a34a; /* Parsley green */
}
.build-tag {
  font-size: 10px;
  color: var(--muted);
  font-weight: 600;
}

.stats-bar {
  display: flex;
  gap: 10px;
  flex: 1;
  align-items: center;
}
.stat-chip {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 12px;
  font-weight: 500;
  padding: 4px 10px;
  border-radius: 20px;
  background: var(--bg);
  border: 1px solid var(--border);
  white-space: nowrap;
  cursor: pointer;
  transition: opacity .1s;
}
.stat-chip:hover { opacity: .8; }
.stat-chip .num { font-size: 14px; font-weight: 700; }
.stat-chip.review  { color: var(--warn);     background: var(--warn-bg);     border-color: #fde68a; }
.stat-chip.ready   { color: var(--ok);       background: var(--ok-bg);       border-color: #bbf7d0; }
.stat-chip.exported{ color: var(--exported); background: var(--exported-bg); border-color: #c4b5fd; }
.stat-chip.total   { color: var(--info);     background: var(--info-bg);     border-color: #bfdbfe; }

.status-badge {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  color: var(--muted);
  white-space: nowrap;
  min-width: 80px;
}



/* Theme toggle button */
.btn-theme {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--card);
  color: var(--muted);
  cursor: pointer;
  transition: all 0.15s;
}
.btn-theme:hover {
  background: var(--bg);
  color: var(--text);
}
.btn-theme .icon-sun {
  display: none;
}
.btn-theme .icon-moon {
  display: block;
}
/* In dark mode: show sun, hide moon */
[data-theme="dark"] .btn-theme .icon-sun {
  display: block;
}
[data-theme="dark"] .btn-theme .icon-moon {
  display: none;
}

/* ── Upload button (sidebar) ─────────────────────────────────────────────── */
.side-upload {
  padding: 10px 12px;
  border-bottom: 1px solid rgba(255,255,255,.07);
  flex-shrink: 0;
}
.upload-btn {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 7px 12px;
  border: 1px solid rgba(255,255,255,.18);
  border-radius: 6px;
  background: rgba(255,255,255,.07);
  color: rgba(255,255,255,.85);
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: background .15s, border-color .15s;
  white-space: nowrap;
}
.upload-btn:hover  { background: rgba(255,255,255,.14); border-color: rgba(255,255,255,.3); }
.upload-btn:disabled { opacity: .45; cursor: not-allowed; }

/* ── Toast notifications ─────────────────────────────────────────────────── */
#toast-container {
  position: fixed;
  bottom: 24px;
  right: 24px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  z-index: 9999;
  pointer-events: none;
}
.toast {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 12px 16px;
  border-radius: 8px;
  font-size: 13px;
  line-height: 1.4;
  max-width: 340px;
  box-shadow: 0 4px 16px rgba(0,0,0,.12);
  pointer-events: all;
  animation: toast-in .2s ease;
}
@keyframes toast-in {
  from { opacity: 0; transform: translateY(8px); }
  to   { opacity: 1; transform: translateY(0); }
}
.toast.success { background: var(--ok-bg);   border: 1px solid #bbf7d0; color: #166534; }
.toast.error   { background: var(--err-bg);  border: 1px solid #fecaca; color: #991b1b; }
.toast.info    { background: var(--info-bg); border: 1px solid #bfdbfe; color: #1e40af; }
.toast-icon { font-size: 14px; flex-shrink: 0; line-height: 1.4; }
.toast-body { flex: 1; }
.status-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  background: var(--muted);
  animation: pulse 2s infinite;
  flex-shrink: 0;
}
.status-badge.idle .status-dot {
  background: var(--ok);
}
.status-badge.processing .status-dot {
  background: var(--info);
}
.status-badge.error .status-dot {
  background: var(--err);
  animation: none;
}
.status-text {
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 180px;
}
@keyframes pulse {
  0%,100% { opacity: 1; transform: scale(1); }
  50%      { opacity: .5; transform: scale(.8); }
}

/* ── Body layout ────────────────────────────────────────────────────────── */
.body-wrap {
  display: flex;
  flex: 1 1 auto;
  min-height: 0;
  overflow: hidden;
}

/* ── Sidebar ────────────────────────────────────────────────────────────── */
aside {
  width: var(--side-w);
  background: var(--sidebar);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  overflow: hidden;
}

/* Status filter tabs */
.side-tabs {
  display: flex;
  flex-shrink: 0;
  border-bottom: 1px solid rgba(255,255,255,.07);
}
.side-tab {
  flex: 1;
  padding: 8px 4px;
  font-size: 10px;
  font-weight: 600;
  text-align: center;
  cursor: pointer;
  color: rgba(255,255,255,.4);
  border-bottom: 2px solid transparent;
  transition: color .1s, border-color .1s;
  text-transform: uppercase;
  letter-spacing: .4px;
  white-space: nowrap;
}
.side-tab:hover { color: rgba(255,255,255,.7); }
.side-tab.active {
  color: #e2e8f0;
  border-bottom-color: var(--accent);
}
.side-tab .tab-count {
  display: inline-block;
  margin-left: 3px;
  padding: 0 4px;
  border-radius: 8px;
  font-size: 9px;
  font-weight: 700;
  background: rgba(255,255,255,.12);
  color: rgba(255,255,255,.6);
  min-width: 16px;
  text-align: center;
}
.side-tab.active .tab-count { background: var(--accent); color: #fff; }

.side-search {
  padding: 8px 12px;
  border-bottom: 1px solid rgba(255,255,255,.07);
  flex-shrink: 0;
}
.side-search input {
  width: 100%;
  background: rgba(255,255,255,.08);
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 6px;
  color: #e2e8f0;
  padding: 7px 10px;
  font-size: 12px;
  outline: none;
}
.side-search input::placeholder { color: rgba(255,255,255,.35); }
.side-search input:focus { border-color: var(--accent); background: rgba(255,255,255,.12); }

.side-list {
  flex: 1;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: rgba(255,255,255,.15) transparent;
}
.side-list::-webkit-scrollbar { width: 4px; }
.side-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,.15); border-radius: 4px; }

.side-item {
  padding: 10px 14px;
  border-bottom: 1px solid rgba(255,255,255,.04);
  cursor: pointer;
  transition: background .1s;
  display: flex;
  flex-direction: column;
  gap: 3px;
}
.side-item:hover  { background: var(--side-hov); }
.side-item.active { background: var(--side-sel); border-left: 3px solid var(--accent); }

.side-item-top {
  display: flex;
  align-items: center;
  gap: 7px;
}
.side-status-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}
.side-status-dot.needs_review { background: var(--warn); }
.side-status-dot.ready        { background: var(--ok); }
.side-status-dot.exported     { background: #7c3aed; opacity: .6; }

.side-inv-num {
  font-size: 12px;
  font-weight: 600;
  color: #e2e8f0;
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.side-total {
  font-size: 11px;
  font-weight: 600;
  color: #94a3b8;
  white-space: nowrap;
}
.side-supplier {
  font-size: 11px;
  color: #64748b;
  padding-left: 15px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.side-date {
  font-size: 10px;
  color: #475569;
  padding-left: 15px;
}

.empty-state {
  padding: 40px 20px;
  text-align: center;
  color: rgba(255,255,255,.3);
  font-size: 12px;
  line-height: 1.6;
}

/* ── Main content ───────────────────────────────────────────────────────── */
main {
  flex: 1;
  display: flex;
  min-height: 0;
  overflow: hidden;
}

/* ── PDF panel ──────────────────────────────────────────────────────────── */
.pdf-panel {
  width: 42%;
  min-width: 200px;
  max-width: 75%;
  min-height: 0;
  background: #d1d5db;
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  overflow: hidden; /* Viewer inside iframe handles its own scrolling */
}

/* ── Resize handle ──────────────────────────────────────────────────────── */
.panel-resizer {
  width: 5px;
  min-height: 0;
  background: var(--border);
  cursor: col-resize;
  flex-shrink: 0;
  position: relative;
  transition: background .15s;
  user-select: none;
}
.panel-resizer:hover,
.panel-resizer.dragging { background: var(--accent); }
.panel-resizer::after {
  content: '';
  position: absolute;
  inset: 0 -5px;  /* widen hit area without affecting layout */
  z-index: 1;
}

.pdf-toolbar {
  background: #374151;
  color: #e2e8f0;
  padding: 8px 14px;
  font-size: 11px;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 8px;
  flex-shrink: 0;
  z-index: 2;
}
.pdf-filename {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.pdf-zoom-ctrl {
  display: flex;
  align-items: center;
  gap: 6px;
}
.btn-zoom {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 4px;
  background: rgba(255,255,255,0.08);
  color: #e2e8f0;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.15s, border-color 0.15s;
}
.btn-zoom:hover {
  background: rgba(255,255,255,0.15);
  border-color: rgba(255,255,255,0.3);
}
.btn-zoom.active {
  background: var(--accent);
  border-color: var(--accent);
  color: #fff;
}
.btn-zoom svg {
  display: block;
}
.zoom-label {
  min-width: 42px;
  text-align: center;
  font-size: 12px;
  font-weight: 500;
  color: #cbd5e1;
}

/* Supplier lookup button in edit mode */
.btn-lookup {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  margin-left: auto;
  padding: 4px 10px;
  font-size: 11px;
  font-weight: 600;
  color: var(--accent);
  background: #dbeafe;
  border: 1px solid #bfdbfe;
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.15s, border-color 0.15s;
}
.btn-lookup:hover {
  background: #bfdbfe;
  border-color: #93c5fd;
}

/* Modal overlay */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.modal-overlay.hidden {
  display: none;
}

/* Modal dialog */
.modal-dialog {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  width: 100%;
  max-width: 600px;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Modal box (compact variant for create supplier, etc.) */
.modal-box {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  width: 100%;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.modal-header {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
  background: #fafbfc;
}
.modal-header h3 {
  flex: 1;
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
  margin: 0;
}
.modal-body {
  flex: 1;
  overflow-y: auto;
  padding: 0;
}
.modal-search {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  background: var(--bg);
}
.modal-search input {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 13px;
  outline: none;
}
.modal-search input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(59,91,219,.12);
}
.supplier-list {
  padding: 0;
}
.supplier-item {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 12px;
  transition: background 0.1s;
}
.supplier-item:hover {
  background: var(--bg);
}
.supplier-item.selected {
  background: #dbeafe;
}
.supplier-info {
  flex: 1;
  min-width: 0;
}
.supplier-name {
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.supplier-meta {
  font-size: 11px;
  color: var(--muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.supplier-abn {
  font-size: 11px;
  font-weight: 600;
  color: var(--accent);
  background: #dbeafe;
  padding: 2px 6px;
  border-radius: 4px;
  white-space: nowrap;
}
.modal-footer {
  padding: 12px 16px;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  background: #fafbfc;
}
.modal-empty {
  padding: 40px;
  text-align: center;
  color: var(--muted);
  font-size: 13px;
}
.modal-warning {
  margin: 0;
  padding: 10px 16px;
  background: #fffbeb;
  border-bottom: 1px solid #fde68a;
  color: #92400e;
  font-size: 12px;
  line-height: 1.5;
}
[data-theme="dark"] .modal-warning {
  background: #2d2005;
  border-color: #78350f;
  color: #fcd34d;
}
.modal-note {
  margin: 12px 0 0;
  font-size: 12px;
  color: var(--muted);
  line-height: 1.5;
}

/* ── Audit / History ─────────────────────────────────────────── */
.audit-section {
  margin-top: 20px;
  border-top: 1px solid var(--border);
  padding-top: 14px;
}
.audit-toggle {
  display: flex;
  align-items: center;
  gap: 6px;
  background: none;
  border: none;
  padding: 0;
  cursor: pointer;
  color: var(--muted);
  font-size: 12px;
  font-weight: 600;
  letter-spacing: .04em;
  text-transform: uppercase;
  user-select: none;
}
.audit-toggle svg { transition: transform .2s; }
.audit-toggle.open svg { transform: rotate(90deg); }
.audit-timeline {
  margin-top: 10px;
  display: flex;
  flex-direction: column;
  gap: 0;
}
.audit-entry {
  display: grid;
  grid-template-columns: 16px 1fr;
  gap: 0 10px;
  position: relative;
  padding-bottom: 10px;
}
.audit-entry::before {          /* connecting line */
  content: '';
  position: absolute;
  left: 7px;
  top: 16px;
  bottom: 0;
  width: 2px;
  background: var(--border);
}
.audit-entry:last-child::before { display: none; }
.audit-dot {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: var(--border);
  border: 2px solid var(--bg);
  flex-shrink: 0;
  margin-top: 1px;
  z-index: 1;
}
.audit-dot.system    { background: #9ca3af; }
.audit-dot.operator  { background: var(--accent); }
.audit-dot.exported  { background: #8b5cf6; }
.audit-dot.status    { background: #f59e0b; }
.audit-body { min-width: 0; }
.audit-action {
  font-size: 12px;
  font-weight: 600;
  color: var(--text);
  line-height: 1.3;
}
.audit-meta {
  font-size: 11px;
  color: var(--muted);
  margin-top: 1px;
}
.audit-detail {
  font-size: 11px;
  color: var(--muted);
  font-style: italic;
}

.pdf-placeholder {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 12px;
  color: #6b7280;
  padding: 40px;
  text-align: center;
}
.pdf-placeholder svg { opacity: .3; }
.pdf-placeholder p { font-size: 12px; line-height: 1.5; }

/* ── Data panel ─────────────────────────────────────────────────────────── */
.data-panel {
  flex: 1;
  min-height: 0;
  overflow-y: auto;
  overscroll-behavior: contain;
  -webkit-overflow-scrolling: touch;
  padding: 0 20px 20px 20px; /* No top padding - action bar handles it */
  display: flex;
  flex-direction: column;
  gap: 14px;
  scrollbar-width: thin;
  scrollbar-color: var(--border) transparent;
}
.data-panel::-webkit-scrollbar { width: 6px; }
.data-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

.no-selection {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 14px;
  color: var(--muted);
  text-align: center;
  padding: 40px;
}
.no-selection svg { opacity: .25; }
.no-selection h3 { font-size: 15px; font-weight: 600; color: var(--text); }
.no-selection p  { font-size: 12px; line-height: 1.6; }

/* ── Cards ──────────────────────────────────────────────────────────────── */
.card {
  display: flex;
  flex-direction: column;
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  overflow: hidden;
  flex-shrink: 0;
}
.card-scroll {
  overflow-y: auto;
  overscroll-behavior: contain;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: thin;
  scrollbar-color: var(--border) transparent;
}
.card-scroll::-webkit-scrollbar { width: 5px; }
.card-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
.card.scroll-card.line-items-card .card-scroll { max-height: 340px; }
.card.scroll-card.disc-card .card-scroll        { max-height: 260px; }

.card-header {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  font-weight: 700;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: .5px;
  background: #fafbfc;
}
.card-header .badge {
  margin-left: auto;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 600;
  text-transform: none;
  letter-spacing: 0;
}
.badge.ok       { background: var(--ok-bg);       color: var(--ok);       }
.badge.warn     { background: var(--warn-bg);      color: var(--warn);     }
.badge.err      { background: var(--err-bg);       color: var(--err);      }
.badge.info     { background: var(--info-bg);      color: var(--info);     }
.badge.exported { background: var(--exported-bg);  color: var(--exported); }
.badge.muted    { background: var(--bg); color: var(--muted); border: 1px solid var(--border); }

/* ── Workflow action bar ─────────────────────────────────────────────────── */
.action-bar {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 8px;
  row-gap: 8px;
  padding: 10px 14px;
  background: var(--card);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  box-shadow: 0 4px 20px rgba(0,0,0,0.15), 0 2px 8px rgba(0,0,0,0.1);
  flex-shrink: 0;
  /* Sticky positioning - stays at top while scrolling */
  position: sticky;
  top: 10px;
  z-index: 100;
  margin-top: 10px;
}
/* Extra background and stronger shadow to cover content scrolling underneath */
.action-bar::before {
  content: '';
  position: absolute;
  inset: 0;
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: 0 8px 30px rgba(0,0,0,0.12);
  z-index: -1;
}
[data-theme="dark"] .action-bar {
  box-shadow: 0 4px 20px rgba(0,0,0,0.4), 0 2px 8px rgba(0,0,0,0.3);
}
[data-theme="dark"] .action-bar::before {
  box-shadow: 0 8px 30px rgba(0,0,0,0.35);
}
.action-bar .status-pill {
  display: flex;
  align-items: center;
  gap: 7px;
  padding: 5px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  border: 1px solid;
}
.status-pill.needs_review { background: var(--warn-bg);     color: var(--warn);     border-color: #fde68a; }
.status-pill.ready        { background: var(--ok-bg);       color: var(--ok);       border-color: #bbf7d0; }
.status-pill.exported     { background: var(--exported-bg); color: var(--exported); border-color: #c4b5fd; }
.status-pill-dot { width: 7px; height: 7px; border-radius: 50%; background: currentColor; }

/* Button group — right-aligned, wraps as a unit when space is tight */
.action-btns {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  margin-left: auto;
}

.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 7px 14px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  border: none;
  cursor: pointer;
  transition: opacity .15s, transform .1s;
  white-space: nowrap;
}
.btn:hover   { opacity: .88; }
.btn:active  { transform: scale(.97); }
.btn:disabled{ opacity: .45; cursor: not-allowed; transform: none; }

.btn-export {
  background: var(--accent);
  color: #fff;
}
.btn-flag {
  background: var(--warn-bg);
  color: var(--warn);
  border: 1px solid #fde68a;
}
.btn-reprocess {
  background: #f1f5f9;
  color: var(--muted);
  border: 1px solid var(--border);
}
.btn-delete {
  background: var(--err-bg);
  color: var(--err);
  border: 1px solid #fca5a5;
}
.action-sep {
  width: 1px;
  height: 24px;
  background: var(--border);
  margin: 0 2px;
  flex-shrink: 0;
}
.btn-exported-label {
  font-size: 11px;
  color: var(--muted);
  display: flex;
  align-items: center;
  gap: 5px;
}

/* ── Status banner (extraction quality) ─────────────────────────────────── */
.status-banner {
  padding: 12px 16px;
  border-radius: var(--radius);
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 12px;
  font-weight: 600;
  border: 1px solid;
}
.status-banner.ok   { background: var(--ok-bg);   color: var(--ok);   border-color: #86efac; }
.status-banner.warn { background: var(--warn-bg); color: var(--warn); border-color: #fcd34d; }
.status-banner.err  { background: var(--err-bg);  color: var(--err);  border-color: #fca5a5; }
.status-banner .meta { margin-left: auto; font-weight: 400; color: var(--muted); font-size: 11px; }

/* ── Grid for key-value pairs ───────────────────────────────────────────── */
.kv-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0;
}
.kv-item {
  padding: 10px 16px;
  border-bottom: 1px solid var(--border);
  border-right: 1px solid var(--border);
}
.kv-item:nth-child(even) { border-right: none; }
.kv-item:nth-last-child(-n+2) { border-bottom: none; }
.kv-label { font-size: 10px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: .4px; margin-bottom: 3px; }
.kv-value { font-size: 13px; color: var(--text); font-weight: 500; word-break: break-word; }
.kv-value.large { font-size: 18px; font-weight: 700; color: var(--accent); }
.kv-value.missing { color: #cbd5e1; font-style: italic; font-weight: 400; }
.kv-value .match-tag {
  display: inline-block;
  font-size: 10px;
  font-weight: 600;
  padding: 1px 6px;
  border-radius: 4px;
  margin-left: 6px;
  vertical-align: middle;
}
.match-tag.ok   { background: var(--ok-bg);   color: var(--ok);   }
.match-tag.warn { background: var(--warn-bg); color: var(--warn); }

/* ── Notes card ─────────────────────────────────────────────────────────── */
.notes-area {
  width: 100%;
  border: none;
  resize: vertical;
  font-family: inherit;
  font-size: 12px;
  color: var(--text);
  padding: 12px 16px;
  background: transparent;
  min-height: 60px;
  outline: none;
}
.notes-area:focus { background: #fafbfc; }
.notes-save-row {
  padding: 6px 12px;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: flex-end;
  background: #fafbfc;
}
.btn-sm {
  padding: 4px 10px;
  font-size: 11px;
  border-radius: 4px;
  font-weight: 600;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--text);
  cursor: pointer;
}
.btn-sm:hover { background: var(--bg); }

/* ── Sidebar actions footer ─────────────────────────────────────────────── */
.side-actions {
  padding: 10px 12px;
  border-top: 1px solid rgba(255,255,255,.1);
  flex-shrink: 0;
}
.btn-export-all {
  width: 100%;
  justify-content: center;
  background: var(--accent);
  color: #fff;
}

/* ── Line items table ───────────────────────────────────────────────────── */
.items-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.items-table th {
  text-align: left;
  padding: 8px 12px;
  background: #fafbfc;
  border-bottom: 1px solid var(--border);
  font-weight: 600;
  color: var(--muted);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: .4px;
  white-space: nowrap;
}
.items-table th:last-child,
.items-table td:last-child { text-align: right; }
.items-table td {
  padding: 9px 12px;
  border-bottom: 1px solid var(--border);
  color: var(--text);
}
.items-table tr:last-child td { border-bottom: none; }
.items-table tr:hover td { background: var(--bg); }
.items-table .sku  { font-size: 11px; color: var(--muted); }
.items-table .mono { font-family: 'SF Mono', 'Fira Code', monospace; }
.items-table .total-row td {
  font-weight: 700;
  background: #fafbfc;
  border-top: 2px solid var(--border);
}
td.match-ok   { color: var(--ok); }
td.match-warn { color: var(--warn); }
td.match-none { color: var(--muted); font-style: italic; }

/* ── Discrepancies ──────────────────────────────────────────────────────── */
.disc-list { display: flex; flex-direction: column; gap: 0; }
.disc-item {
  padding: 10px 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: flex-start;
  gap: 10px;
}
.disc-item:last-child { border-bottom: none; }
.disc-icon {
  width: 18px; height: 18px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  font-size: 10px;
  font-weight: 800;
  margin-top: 1px;
}
.disc-icon.err  { background: var(--err-bg);  color: var(--err);  }
.disc-icon.warn { background: var(--warn-bg); color: var(--warn); }
.disc-icon.info { background: var(--info-bg); color: var(--info); }
.disc-body { flex: 1; }
.disc-field { font-size: 10px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: .4px; margin-bottom: 2px; }
.disc-desc  { font-size: 12px; color: var(--text); line-height: 1.4; }

/* ── Meta footer ────────────────────────────────────────────────────────── */
.meta-footer {
  font-size: 11px;
  color: var(--muted);
  display: flex;
  gap: 16px;
  padding: 10px 16px;
  background: var(--card);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  flex-wrap: wrap;
}
.meta-footer span { display: flex; align-items: center; gap: 5px; }

/* ── Loading spinner ────────────────────────────────────────────────────── */
.spinner {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 14px;
  flex: 1;
  padding: 40px;
  color: var(--muted);
  font-size: 12px;
}
.spin-ring {
  width: 32px; height: 32px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin .7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ── Scrollbar global ───────────────────────────────────────────────────── */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

/* ── Tablet / mobile controls (hidden on desktop) ───────────────────────── */
.menu-btn {
  display: none;
  align-items: center;
  justify-content: center;
  width: 36px; height: 36px;
  border: none;
  background: none;
  cursor: pointer;
  border-radius: 6px;
  color: var(--text);
  flex-shrink: 0;
}
.menu-btn:hover { background: var(--bg); }
.menu-btn svg { display: block; }

.sidebar-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.35);
  z-index: 90;
}
.sidebar-overlay.visible { display: block; }

/* Panel tab strip (PDF / Data toggle on tablet) */
.main-tabs {
  display: none;
  flex-shrink: 0;
  background: var(--card);
  border-bottom: 1px solid var(--border);
}
.main-tab {
  flex: 1;
  padding: 10px;
  font-size: 12px;
  font-weight: 600;
  text-align: center;
  cursor: pointer;
  color: var(--muted);
  border-bottom: 2px solid transparent;
  transition: color .1s, border-color .1s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}
.main-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

/* ── Tablet layout (≤ 900px) ─────────────────────────────────────────────── */
@media (max-width: 900px) {
  /* Header: show menu button, compact stats */
  .menu-btn { display: flex; }
  .stats-bar { gap: 6px; }
  .stat-chip span:not(.num) { display: none; }  /* hide labels, show numbers only */
  .stat-chip { padding: 4px 8px; }

  /* Sidebar: slide-out drawer */
  aside {
    position: fixed;
    z-index: 100;
    top: var(--hdr-h);
    left: calc(-1 * var(--side-w) - 4px);
    height: calc(100% - var(--hdr-h));
    transition: left .25s ease, box-shadow .25s ease;
    box-shadow: none;
  }
  aside.drawer-open {
    left: 0;
    box-shadow: 4px 0 24px rgba(0,0,0,.25);
  }

  /* Main area: stacked panels */
  main { flex-direction: column; overflow: hidden; }

  /* Show the PDF/Data tab strip */
  .main-tabs { display: flex; }

  /* PDF panel: full width, hidden until its tab is active */
  .pdf-panel {
    width: 100% !important;  /* override inline style from resizer */
    max-width: 100%;
    min-width: 0;
    flex: 1;
    border-right: none;
    display: none;
  }
  .pdf-panel.panel-active { display: flex; }

  /* Drag resizer: hidden on tablet */
  .panel-resizer { display: none; }

  /* Data panel: full width, hidden until its tab is active */
  .data-panel {
    display: none;
    flex: 1;
  }
  .data-panel.panel-active { display: flex; }

  /* Larger touch targets for buttons */
  .btn { padding: 9px 14px; }
  .side-item { padding: 12px 14px; }

  /* Wider kv grid on tablet (single column) */
  .kv-grid { grid-template-columns: 1fr; }
  .kv-item { border-right: none !important; }
  .kv-item:nth-last-child(-n+2) { border-bottom: 1px solid var(--border); }
  .kv-item:last-child { border-bottom: none; }
}

/* ── Keyboard shortcuts help ────────────────────────────────────────────── */
kbd {
  font-family: 'SFMono-Regular', Consolas, monospace;
  font-size: 11px;
  background: var(--card);
  border: 1px solid var(--border);
  border-bottom-width: 2px;
  border-radius: 4px;
  padding: 2px 6px;
  display: inline-block;
  min-width: 20px;
  text-align: center;
}
[data-theme="dark"] kbd {
  background: var(--bg);
  border-color: var(--border);
}

/* ── Edit mode ──────────────────────────────────────────────────────────── */
.edit-input {
  width: 100%;
  padding: 5px 8px;
  border: 1px solid var(--border);
  border-radius: 4px;
  font-family: inherit;
  font-size: 13px;
  color: var(--text);
  background: #fff;
  outline: none;
}
.edit-input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(59,91,219,.12);
}
.btn-edit {
  background: #f1f5f9;
  color: var(--text);
  border: 1px solid var(--border);
}
.btn-save-edit  { background: var(--accent); color: #fff; }
.btn-cancel-edit { background: #f1f5f9; color: var(--muted); border: 1px solid var(--border); }

.corrected-tag {
  display: inline-block;
  font-size: 9px;
  font-weight: 700;
  padding: 1px 5px;
  border-radius: 3px;
  background: #dbeafe;
  color: var(--info);
  margin-left: 5px;
  text-transform: uppercase;
  letter-spacing: .3px;
  vertical-align: middle;
}

/* Editable line items table */
.edit-li-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.edit-li-table th {
  text-align: left;
  padding: 7px 8px;
  background: #fafbfc;
  border-bottom: 1px solid var(--border);
  font-weight: 600;
  color: var(--muted);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: .4px;
  white-space: nowrap;
}
.edit-li-table td {
  padding: 5px 6px;
  border-bottom: 1px solid var(--border);
  vertical-align: middle;
}
.edit-li-table tr:last-child td { border-bottom: none; }
.edit-li-table .edit-input { font-size: 12px; }
.btn-row-del {
  background: none;
  border: none;
  color: var(--err);
  cursor: pointer;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 16px;
  line-height: 1;
  opacity: .65;
}
.btn-row-del:hover { opacity: 1; background: var(--err-bg); }
.btn-add-row {
  margin: 8px 12px;
  padding: 6px 12px;
  font-size: 11px;
  border-radius: 4px;
  border: 1px dashed var(--border);
  background: none;
  color: var(--muted);
  cursor: pointer;
  width: calc(100% - 24px);
  text-align: center;
}
.btn-add-row:hover { background: var(--bg); color: var(--text); border-color: var(--accent); }

.edit-mode-notice {
  background: #dbeafe;
  color: var(--info);
  display: flex;
  align-items: center;
  gap: 8px;
  flex-shrink: 0;
}

/* PDF.js Text Layer Styles */
.textLayer {
  overflow: hidden;
  line-height: 1;
  z-index: 2;
}
/* Each span is absolutely positioned by PDF.js transforms.
   color:transparent hides the duplicate text (canvas renders the visible copy).
   transform-origin and white-space:pre are required for correct placement. */
.textLayer span {
  position: absolute;
  white-space: pre;
  color: transparent;
  transform-origin: 0% 0%;
  cursor: text;
  user-select: text;
  -webkit-user-select: text;
}
/* When in grab mode, disable text selection so dragging works reliably */
.pdf-viewer-container.grab-mode .textLayer span {
  cursor: inherit;
  user-select: none;
  -webkit-user-select: none;
}

/* Dark mode adjustments */
[data-theme="dark"] header {
  background: var(--card);
  border-bottom-color: var(--border);
}
[data-theme="dark"] .pdf-toolbar {
  background: #0f172a;
  border-bottom: 1px solid #334155;
}
[data-theme="dark"] .pdf-panel {
  background: #0a0a0a;
}
[data-theme="dark"] .pdf-viewer-container {
  background: #0a0a0a;
}
[data-theme="dark"] .pdf-placeholder {
  background: #0a0a0a;
  color: #9ca3af;
}
[data-theme="dark"] .page-container {
  box-shadow: 0 5px 30px rgba(0,0,0,0.6);
}
[data-theme="dark"] .kv-grid {
  background: var(--card);
}
[data-theme="dark"] .kv-label {
  color: var(--muted);
}
[data-theme="dark"] .kv-value {
  color: var(--text);
}
[data-theme="dark"] .card-header {
  background: rgba(255,255,255,0.03);
  border-bottom-color: var(--border);
}
[data-theme="dark"] .items-table th {
  background: rgba(255,255,255,0.03);
}
[data-theme="dark"] .edit-mode-notice {
  background: rgba(59, 130, 246, 0.2);
}
[data-theme="dark"] .edit-input {
  background: var(--bg);
  border-color: var(--border);
  color: var(--text);
}
[data-theme="dark"] .modal-dialog,
[data-theme="dark"] .modal-box {
  background: var(--card);
}
[data-theme="dark"] .modal-header,
[data-theme="dark"] .modal-footer {
  background: var(--bg);
}
[data-theme="dark"] .supplier-item:hover {
  background: var(--bg);
}
[data-theme="dark"] .supplier-item.selected {
  background: rgba(59, 130, 246, 0.3);
}
[data-theme="dark"] .modal-search {
  background: var(--bg);
  border-bottom-color: var(--border);
}
[data-theme="dark"] .modal-search input {
  background: var(--card);
  border-color: var(--border);
  color: var(--text);
}
[data-theme="dark"] input.edit-input {
  background: var(--bg);
  color: var(--text);
  border-color: var(--border);
}
[data-theme="dark"] .btn-add-row {
  border-color: var(--border);
  color: var(--muted);
}
[data-theme="dark"] .btn-add-row:hover {
  border-color: var(--accent);
  color: var(--text);
}
[data-theme="dark"] .btn-row-del:hover {
  background: rgba(220, 38, 38, 0.2);
}
[data-theme="dark"] .notes-save-row {
  background: rgba(255,255,255,0.03);
}
[data-theme="dark"] .items-table .total-row td {
  background: rgba(255,255,255,0.05);
}
[data-theme="dark"] .btn-reprocess {
  background: var(--bg);
  color: var(--text);
  border-color: var(--border);
}
[data-theme="dark"] .btn-reprocess:hover {
  background: var(--card);
}
[data-theme="dark"] .btn-edit {
  background: var(--bg);
  color: var(--text);
  border-color: var(--border);
}
[data-theme="dark"] .btn-edit:hover {
  background: var(--card);
}
[data-theme="dark"] .edit-li-table th {
  background: rgba(255,255,255,0.05);
}

/* PO Lines lookup panel (slides down from top) */
.po-lines-panel {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 22vh;
  min-height: 180px;
  max-height: 60vh;
  background: var(--card);
  border-bottom: 2px solid var(--accent);
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  z-index: 2000;
  display: flex;
  flex-direction: column;
  transform: translateY(-100%);
  transition: transform 0.25s ease;
}
.po-lines-panel.visible {
  transform: translateY(0);
}

/* Resize handle for PO panel */
.po-lines-resize-handle {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 6px;
  cursor: ns-resize;
  background: transparent;
  z-index: 2001;
}
.po-lines-resize-handle:hover,
.po-lines-resize-handle.dragging {
  background: var(--accent);
  opacity: 0.5;
}

/* Dark mode: darker background for PO panel */
[data-theme="dark"] .po-lines-panel {
  background: #141b2d;
  border-bottom-color: #3b5bdb;
}
[data-theme="dark"] .po-lines-header {
  background: #0f172a;
  border-bottom-color: #334155;
}
[data-theme="dark"] .po-lines-table th {
  background: #0f172a;
}
[data-theme="dark"] .po-sku {
  color: #60a5fa; /* Lighter blue for dark mode */
}
[data-theme="dark"] .po-lines-table tr:hover td {
  background: rgba(255,255,255,0.03);
}
.po-lines-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 16px;
  background: var(--bg);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.po-lines-header h4 {
  margin: 0;
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  flex: 1;
}
.po-lines-header .po-number {
  font-family: 'SF Mono', monospace;
  font-size: 12px;
  color: var(--accent);
  background: var(--info-bg);
  padding: 2px 8px;
  border-radius: 4px;
}
.po-lines-content {
  flex: 1;
  overflow-y: auto;
  padding: 12px 16px;
}
.po-lines-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}
.po-lines-table th {
  text-align: left;
  padding: 6px 8px;
  background: var(--bg);
  border-bottom: 1px solid var(--border);
  font-weight: 600;
  color: var(--muted);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.4px;
  white-space: nowrap;
  position: sticky;
  top: 0;
}
.po-lines-table td {
  padding: 8px;
  border-bottom: 1px solid var(--border);
  color: var(--text);
}
.po-lines-table tr:hover td {
  background: var(--bg);
}
.po-lines-table tr.matched td {
  opacity: 0.5;
}
.po-lines-table .po-sku {
  font-family: 'SF Mono', monospace;
  font-size: 11px;
  color: var(--accent);
}
.po-lines-actions {
  display: flex;
  gap: 6px;
  white-space: nowrap;
}
.btn-po-copy {
  padding: 3px 8px;
  font-size: 10px;
  font-weight: 600;
  border-radius: 4px;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--text);
  cursor: pointer;
  transition: all 0.15s;
}
.btn-po-copy:hover {
  background: var(--accent);
  border-color: var(--accent);
  color: #fff;
}
.btn-po-copy.sku-only {
  background: transparent;
}
.btn-po-copy.sku-only:hover {
  background: var(--bg);
  color: var(--text);
  border-color: var(--accent);
}
.po-lines-empty {
  padding: 24px;
  text-align: center;
  color: var(--muted);
  font-size: 13px;
}
.po-lines-close {
  margin-left: auto;
}

/* Selected row highlight in edit table */
.edit-li-table tr.selected {
  background: rgba(59, 91, 219, 0.1);
  outline: 2px solid var(--accent);
  outline-offset: -2px;
}
[data-theme="dark"] .edit-li-table tr.selected {
  background: rgba(59, 91, 219, 0.2);
}

/* PO Lookup button in edit mode */
.btn-po-lookup {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  margin-left: auto;
  padding: 4px 10px;
  font-size: 11px;
  font-weight: 600;
  color: var(--info);
  background: var(--info-bg);
  border: 1px solid #bfdbfe;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.15s;
}
.btn-po-lookup:hover {
  background: #bfdbfe;
  border-color: #93c5fd;
}
[data-theme="dark"] .btn-po-lookup {
  border-color: rgba(59, 130, 246, 0.3);
}

.pdf-viewer-container {
  flex: 1;
  overflow: auto;
  position: relative;
  background: #525659;
  text-align: center;
  /* No padding here - we handle spacing via page margins */
  width: 100%;
  height: 100%;
}
.pdf-viewer-container.grabbing { cursor: grabbing; }
.pdf-viewer-container.grab-mode:not(.grabbing) { cursor: grab; }
/* When in grab mode, show grab cursor on page containers but allow text selection */
.pdf-viewer-container.grab-mode .page-container {
  cursor: grab;
}
.pdf-viewer-container.grab-mode.grabbing .page-container {
  cursor: grabbing;
}

#viewer-pages {
  display: inline-block;
  text-align: left;
  padding: 4px; /* Minimal padding to prevent shadow clipping */
}

.page-container {
  position: relative;
  margin: 0 auto;
  box-shadow: 0 5px 30px rgba(0,0,0,0.4);
  background: white;
  z-index: 1;
}
.page-container:last-child {
  margin-bottom: 0;
}

</style>
<!-- PDF.js -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  // Initialize PDF.js worker
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>
</head>
<body>

<!-- ── Header ──────────────────────────────────────────────────────────── -->
<header>
  <!-- Hamburger: tablet only -->
  <button class="menu-btn" id="menu-btn" onclick="toggleSidebar()" aria-label="Toggle sidebar">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="3" y1="6"  x2="21" y2="6"/>
      <line x1="3" y1="12" x2="21" y2="12"/>
      <line x1="3" y1="18" x2="21" y2="18"/>
    </svg>
  </button>
  <div class="app-title">
    <!-- Parsley herb icon: curly parsley sprig -->
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
      <!-- Central stem -->
      <path d="M12 20 C12 18 12 16 12 14 C12 12 12 10 13 8" fill="none"/>
      <!-- Large curly leaf left -->
      <path d="M12 15 C9 15 7 13 7 10 C7 7 9 5 12 6 C11 8 10 10 11 12 C12 13 13 14 12 15Z" fill="currentColor" stroke="none" opacity="0.9"/>
      <path d="M12 15 C9 15 7 13 7 10 C7 7 9 5 12 6" fill="none"/>
      <!-- Large curly leaf right -->
      <path d="M12 12 C15 12 17 10 17 7 C17 4 15 3 12 4 C13 6 14 8 13 10 C12 11 11 11 12 12Z" fill="currentColor" stroke="none" opacity="0.9"/>
      <path d="M12 12 C15 12 17 10 17 7 C17 4 15 3 12 4" fill="none"/>
      <!-- Top leaf cluster -->
      <path d="M13 8 C11 6 12 4 14 3 C15 4 15 6 13 8Z" fill="currentColor" stroke="none"/>
      <path d="M13 8 C11 6 12 4 14 3" fill="none"/>
      <!-- Small leaflet left -->
      <path d="M11 13 C9 12 9 10 10 9 C11 10 12 12 11 13Z" fill="currentColor" stroke="none" opacity="0.7"/>
      <!-- Small leaflet right -->
      <path d="M13 10 C15 9 15 7 14 6 C13 7 12 9 13 10Z" fill="currentColor" stroke="none" opacity="0.7"/>
    </svg>
    Parsely <span class="build-tag">build 2026-02-25-i</span>
  </div>
  <button class="btn-theme" id="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">
    <!-- Sun icon (shown in dark mode) -->
    <svg class="icon-sun" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="5"/>
      <line x1="12" y1="1" x2="12" y2="3"/>
      <line x1="12" y1="21" x2="12" y2="23"/>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
      <line x1="1" y1="12" x2="3" y2="12"/>
      <line x1="21" y1="12" x2="23" y2="12"/>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
    </svg>
    <!-- Moon icon (shown in light mode) -->
    <svg class="icon-moon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
    </svg>
  </button>
  <div class="stats-bar">
    <div class="stat-chip review" onclick="setTab('needs_review')" title="Filter: Needs Review">
      <span class="num" id="stat-review">—</span>
      <span>Needs Review</span>
    </div>
    <div class="stat-chip ready" onclick="setTab('ready')" title="Filter: Ready">
      <span class="num" id="stat-ready">—</span>
      <span>Ready</span>
    </div>
    <div class="stat-chip exported" onclick="setTab('exported')" title="Filter: Exported">
      <span class="num" id="stat-exported">—</span>
      <span>Exported</span>
    </div>
    <div class="stat-chip total" onclick="setTab(null)" title="Show all">
      <span class="num" id="stat-total">—</span>
      <span>Total</span>
    </div>
  </div>
  <div class="status-badge" id="status-badge" title="System status">
    <div class="status-dot" id="status-dot"></div>
    <span class="status-text" id="status-text">Connecting…</span>
  </div>
  <button onclick="showShortcutsHelp()" title="Keyboard shortcuts (?)" style="text-decoration:none;font-size:10px;font-weight:700;padding:4px 8px;border-radius:12px;border:1px solid var(--border);color:var(--muted);background:var(--bg);text-transform:uppercase;letter-spacing:.5px;white-space:nowrap;cursor:pointer;font-family:inherit">⌨️ ?</button>
  <a href="/admin" style="text-decoration:none;font-size:10px;font-weight:700;padding:4px 8px;border-radius:12px;border:1px solid var(--border);color:var(--muted);background:var(--bg);text-transform:uppercase;letter-spacing:.5px;white-space:nowrap">Admin</a>
  <form id="logout-form" method="post" action="/logout" style="display:none;margin:0">
    <button type="submit" id="logout-btn" title="Sign out" style="display:flex;align-items:center;gap:5px;font-size:10px;font-weight:700;padding:4px 8px;border-radius:12px;border:1px solid var(--border);color:var(--muted);background:var(--bg);cursor:pointer;text-transform:uppercase;letter-spacing:.5px;font-family:inherit;white-space:nowrap">
      <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      <span id="logout-label">Sign out</span>
    </button>
  </form>
</header>

<!-- Toast container -->
<div id="toast-container"></div>

<!-- Sidebar overlay (tablet: tap outside to close) -->
<div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

<div class="body-wrap">

  <!-- ── Sidebar ─────────────────────────────────────────────────────── -->
  <aside>
    <div class="side-upload">
      <button class="upload-btn" id="upload-btn" onclick="triggerUpload()" title="Upload an invoice PDF">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="17 8 12 3 7 8"/>
          <line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
        <span id="upload-btn-label">Upload Invoice</span>
      </button>
      <input type="file" id="upload-input" accept=".pdf" style="display:none" onchange="handleUpload(this)">
    </div>
    <div class="side-tabs">
      <div class="side-tab"        data-tab="all"          onclick="setTab(null)">All<span class="tab-count" id="tab-count-all">—</span></div>
      <div class="side-tab active" data-tab="needs_review" onclick="setTab('needs_review')">Review<span class="tab-count" id="tab-count-review">—</span></div>
      <div class="side-tab"        data-tab="ready"        onclick="setTab('ready')">Ready<span class="tab-count" id="tab-count-ready">—</span></div>
      <div class="side-tab"        data-tab="exported"     onclick="setTab('exported')">Done<span class="tab-count" id="tab-count-exported">—</span></div>
    </div>
    <div class="side-search">
      <input type="text" id="search-input" placeholder="Search invoices…" oninput="filterList()">
    </div>
    <div class="side-list" id="side-list">
      <div class="empty-state">Loading invoices…</div>
    </div>
    <div class="side-actions" id="side-actions" style="display:none">
      <button class="btn btn-export-all" id="export-all-btn" onclick="exportAll()">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="17 8 12 3 7 8"/>
          <line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
        Export All Ready (<span id="export-all-count">0</span>)
      </button>
    </div>
    <div class="side-footer" style="margin-top:auto;padding:12px;border-top:1px solid rgba(255,255,255,.07);flex-shrink:0">
      <a href="/help" class="side-help-link" style="display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:6px;color:rgba(255,255,255,.6);text-decoration:none;font-size:12px;transition:all .15s" onmouseover="this.style.color='#fff';this.style.background='rgba(255,255,255,.08)'" onmouseout="this.style.color='rgba(255,255,255,.6)';this.style.background='transparent'">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity:.7">
          <circle cx="12" cy="12" r="10"/>
          <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
          <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
        Help & Documentation
      </a>
    </div>
  </aside>

  <!-- ── Main ────────────────────────────────────────────────────────── -->
  <main>
    <!-- Panel tabs: PDF ↔ Data (tablet only, hidden on desktop) -->
    <div class="main-tabs" id="main-tabs">
      <div class="main-tab" id="tab-pdf" onclick="setPanel('pdf')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <polyline points="14 2 14 8 20 8"/>
        </svg>
        Original PDF
      </div>
      <div class="main-tab active" id="tab-data" onclick="setPanel('data')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/>
          <line x1="8" y1="18" x2="21" y2="18"/>
          <line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/>
          <line x1="3" y1="18" x2="3.01" y2="18"/>
        </svg>
        Extracted Data
      </div>
    </div>

    <!-- PDF Panel -->
    <div class="pdf-panel" id="pdf-panel">
      <div class="pdf-placeholder" id="pdf-placeholder">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <polyline points="14 2 14 8 20 8"/>
        </svg>
        <p>Select an invoice from the sidebar<br>to view the original document.</p>
      </div>
    </div>

    <!-- Drag handle -->
    <div class="panel-resizer" id="panel-resizer" title="Drag to resize"></div>

    <!-- Data Panel -->
    <div class="data-panel panel-active" id="data-panel">
      <div class="no-selection">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="11" cy="11" r="8"/>
          <line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
        <h3>No invoice selected</h3>
        <p>Choose an invoice from the sidebar to see<br>extracted data, matched POs, and discrepancies.</p>
      </div>
    </div>
  </main>

</div>

<script>
// ════════════════════════════════════════════════════════════════════════════
// State
// ════════════════════════════════════════════════════════════════════════════
const S = {
  invoices:         [],    // full list from /api/invoices (for current tab)
  filtered:         [],    // after search filter
  selected:         null,  // stem string
  activeTab:        'needs_review',  // default to review
  lastUpdated:      null,
  pollErrors:       0,
  stats:            {},
  _autoSelectFirst: true, // auto-select first item on boot
  editing:          false, // edit mode active
  editLineItems:    [],    // working copy of line items in edit mode
  currentResult:    null,  // last-loaded full result (for edit / re-render)
  pdfZoom:          100,   // PDF zoom level (%);
  lastPipelineStatus: null, // cached pipeline status
};

// ════════════════════════════════════════════════════════════════════════════
// API helpers
// ════════════════════════════════════════════════════════════════════════════
const api = {
  get:    url           => fetch(url).then(r => { if (!r.ok) throw new Error(r.status); return r.json(); }),
  post:   url           => fetch(url, { method: 'POST' }).then(r => { if (!r.ok) return r.json().then(e => { throw new Error(e.detail || r.status); }); return r.json(); }),
  patch:  (url, body)   => fetch(url, { method: 'PATCH', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) }).then(r => { if (!r.ok) return r.json().then(e => { throw new Error(e.detail || r.status); }); return r.json(); }),
  del:    url           => fetch(url, { method: 'DELETE' }).then(r => { if (!r.ok) return r.json().then(e => { throw new Error(e.detail || r.status); }); return r.json(); }),

  stats:   ()     => api.get('/api/stats'),
  list:    (tab)  => api.get('/api/invoices' + (tab ? `?status=${encodeURIComponent(tab)}` : '')),
  detail:  stem   => api.get(`/api/invoices/${encodeURIComponent(stem)}`),
  pages:   stem   => api.get(`/api/invoices/${encodeURIComponent(stem)}/pages`),
  export:        stem   => api.post(`/api/invoices/${encodeURIComponent(stem)}/export`),
  reprocess:     stem   => api.post(`/api/invoices/${encodeURIComponent(stem)}/reprocess`),
  deleteInvoice: stem   => api.del(`/api/invoices/${encodeURIComponent(stem)}`),
  bulkExport: ()        => api.post('/api/bulk-export'),
  setStatus: (stem, status) => api.patch(`/api/invoices/${encodeURIComponent(stem)}/status`, { status }),
  saveNotes:       (stem, notes) => api.patch(`/api/invoices/${encodeURIComponent(stem)}/notes`, { notes }),
  saveCorrections: (stem, corr)  => api.patch(`/api/invoices/${encodeURIComponent(stem)}/corrections`, { corrections: corr }),
  auditLog:        stem           => api.get(`/api/invoices/${encodeURIComponent(stem)}/audit`),
};

// ════════════════════════════════════════════════════════════════════════════
// Polling
// ════════════════════════════════════════════════════════════════════════════
async function poll() {
  try {
    const [stats, invoices, pipelineStatus] = await Promise.all([
      api.stats(),
      api.list(S.activeTab),
      api.get('/api/pipeline/status').catch(() => null)
    ]);

    const hadNone    = S.invoices.length === 0;
    S.invoices       = invoices;
    S.stats          = stats;
    S.pollErrors     = 0;
    S.lastUpdated    = new Date();
    S.lastPipelineStatus = pipelineStatus;

    renderStats(stats);
    filterList();  // updates S.filtered

    // Initial page load: auto-select the first invoice
    if (hadNone && !S.selected && S.filtered.length > 0) {
      selectInvoice(S.filtered[0].stem);
    }

    // Tab switch: auto-select the first invoice in the new queue
    if (S._autoSelectFirst) {
      S._autoSelectFirst = false;
      if (S.filtered.length > 0) selectInvoice(S.filtered[0].stem);
    }

    updateStatusIndicator(true, pipelineStatus);
  } catch (e) {
    S.pollErrors++;
    updateStatusIndicator(false, null);
  }
}

function updateStatusIndicator(connectionOk, pipelineStatus) {
  const badge = document.getElementById('status-badge');
  const dot = document.getElementById('status-dot');
  const text = document.getElementById('status-text');
  if (!badge || !dot || !text) return;
  
  // Remove existing status classes
  badge.classList.remove('idle', 'processing', 'error');
  
  // Connection error takes precedence
  if (!connectionOk) {
    badge.classList.add('error');
    text.textContent = 'Connection error';
    return;
  }
  
  // Pipeline status
  if (pipelineStatus) {
    if (pipelineStatus.status === 'processing') {
      badge.classList.add('processing');
      const filename = pipelineStatus.current_file || '...';
      // Truncate filename if too long
      text.textContent = filename.length > 20 ? `Processing: ${filename.substring(0, 17)}...` : `Processing: ${filename}`;
    } else if (pipelineStatus.status === 'error') {
      badge.classList.add('error');
      text.textContent = 'Pipeline error';
      badge.title = pipelineStatus.last_error || 'Unknown error';
    } else if (pipelineStatus.queue_length > 0) {
      badge.classList.add('idle');
      text.textContent = `${pipelineStatus.queue_length} pending`;
    } else {
      badge.classList.add('idle');
      const sec = S.lastUpdated ? Math.round((Date.now() - S.lastUpdated) / 1000) : 0;
      text.textContent = sec < 5 ? 'Live' : `Updated ${sec}s ago`;
    }
  } else {
    // No pipeline status yet, just show connection
    badge.classList.add('idle');
    const sec = S.lastUpdated ? Math.round((Date.now() - S.lastUpdated) / 1000) : 0;
    text.textContent = sec < 5 ? 'Live' : `Updated ${sec}s ago`;
  }
}

setInterval(() => {
  if (S.lastUpdated) {
    // Re-update with cached status to refresh the time text
    updateStatusIndicator(S.pollErrors === 0, S.lastPipelineStatus);
  }
}, 5000);

// ════════════════════════════════════════════════════════════════════════════
// Tab switching
// ════════════════════════════════════════════════════════════════════════════
function setTab(tab) {
  S.activeTab        = tab;
  S.selected         = null;
  S._autoSelectFirst = true;  // auto-select first invoice after poll refreshes

  document.querySelectorAll('.side-tab').forEach(el => {
    el.classList.toggle('active', el.dataset.tab === (tab || 'all'));
  });

  document.getElementById('pdf-panel').innerHTML  = placeholderHtml();
  document.getElementById('data-panel').innerHTML = noSelectionHtml();

  if (isTablet()) closeSidebar();

  poll();
}

// ════════════════════════════════════════════════════════════════════════════
// Stats bar
// ════════════════════════════════════════════════════════════════════════════
function renderStats(stats) {
  setText('stat-review',   stats.needs_review ?? '—');
  setText('stat-ready',    stats.ready        ?? '—');
  setText('stat-exported', stats.exported     ?? '—');
  setText('stat-total',    stats.total        ?? '—');

  // Tab counts
  setText('tab-count-all',      stats.total        ?? '—');
  setText('tab-count-review',   stats.needs_review ?? '—');
  setText('tab-count-ready',    stats.ready        ?? '—');
  setText('tab-count-exported', stats.exported     ?? '—');
}

// ════════════════════════════════════════════════════════════════════════════
// Sidebar list
// ════════════════════════════════════════════════════════════════════════════
function filterList() {
  const q = document.getElementById('search-input').value.toLowerCase().trim();
  S.filtered = q
    ? S.invoices.filter(inv =>
        [inv.invoice_number, inv.supplier_name, inv.matched_supplier,
         inv.po_number, inv.matched_po, inv.stem]
          .some(v => v && v.toLowerCase().includes(q))
      )
    : S.invoices;
  renderList();
}

function renderList() {
  const el = document.getElementById('side-list');
  if (!S.filtered.length) {
    el.innerHTML = `<div class="empty-state">${
      S.invoices.length ? 'No results match your search.' : 'No invoices in this view.'
    }</div>`;
  } else {
    el.innerHTML = S.filtered.map(inv => sideItemHtml(inv)).join('');
    if (S.selected) {
      const active = el.querySelector(`[data-stem="${CSS.escape(S.selected)}"]`);
      if (active) active.classList.add('active');
    }
  }

  // Show Export All button only in the Ready tab when there are items
  const actionsEl  = document.getElementById('side-actions');
  const countEl    = document.getElementById('export-all-count');
  const showExport = S.activeTab === 'ready' && S.filtered.length > 0;
  if (actionsEl) actionsEl.style.display = showExport ? '' : 'none';
  if (countEl)   countEl.textContent     = S.filtered.length;
}

function sideItemHtml(inv) {
  const status   = inv.status || 'needs_review';
  const label    = inv.invoice_number ?? inv.stem ?? '(unknown)';
  const supplier = inv.matched_supplier ?? inv.supplier_name ?? '—';
  const total    = inv.total != null ? `${inv.currency || ''} ${fmt(inv.total)}`.trim() : '';
  const date     = inv.invoice_date ?? '';

  return `<div class="side-item" data-stem="${esc(inv.stem)}" onclick="selectInvoice('${esc(inv.stem)}')">
    <div class="side-item-top">
      <div class="side-status-dot ${status}"></div>
      <span class="side-inv-num">${esc(label)}</span>
      ${total ? `<span class="side-total">${esc(total)}</span>` : ''}
    </div>
    <div class="side-supplier">${esc(supplier)}</div>
    ${date ? `<div class="side-date">${esc(date)}</div>` : ''}
  </div>`;
}

// ════════════════════════════════════════════════════════════════════════════
// Invoice selection
// ════════════════════════════════════════════════════════════════════════════
async function selectInvoice(stem) {
  if (S.selected === stem) return;
  if (S.editing) {
    if (!confirm('You have unsaved edits. Leave without saving?')) return;
    S.editing = false;
  }
  S.selected = stem;

  document.querySelectorAll('.side-item').forEach(el =>
    el.classList.toggle('active', el.dataset.stem === stem)
  );

  document.getElementById('pdf-panel').innerHTML  = spinnerHtml('Rendering PDF…');
  document.getElementById('data-panel').innerHTML = spinnerHtml('Loading extraction…');

  try {
    const [result, pages] = await Promise.all([api.detail(stem), api.pages(stem)]);
    renderPdf(result, pages && pages.length > 0);
    renderData(result);
    loadAuditLog(stem);   // async — appends history section after render
    // On tablet: switch to data panel and close sidebar
    if (isTablet()) { setPanel('data'); closeSidebar(); }
  } catch (e) {
    document.getElementById('pdf-panel').innerHTML  = errorHtml('Could not load PDF.');
    document.getElementById('data-panel').innerHTML = errorHtml('Could not load result: ' + e.message);
  }
}

// ════════════════════════════════════════════════════════════════════════════
// Auto-advance after workflow actions
// ════════════════════════════════════════════════════════════════════════════
async function autoAdvance(stem, prevIndex) {
  const stillInList = S.filtered.some(inv => inv.stem === stem);
  console.log('autoAdvance:', { stem, prevIndex, stillInList, filteredLength: S.filtered.length });

  if (stillInList) {
    // Item is still in this queue (e.g. "all" tab, or status change within same queue).
    // Re-fetch and re-render to reflect the new status without re-triggering the guard.
    try {
      const [result, pages] = await Promise.all([api.detail(stem), api.pages(stem)]);
      renderPdf(result, pages);
      renderData(result);
    } catch (e) {
      document.getElementById('data-panel').innerHTML = errorHtml('Could not reload: ' + e.message);
    }
  } else if (S.filtered.length > 0) {
    // Item left the current queue — advance to the next position (or last if at end).
    const nextIndex = Math.min(Math.max(prevIndex, 0), S.filtered.length - 1);
    console.log('autoAdvance: selecting next invoice at index', nextIndex);
    S.selected = null;  // clear so selectInvoice guard doesn't short-circuit
    selectInvoice(S.filtered[nextIndex].stem);
  } else {
    // Queue is now empty.
    console.log('autoAdvance: queue empty, clearing panels');
    S.selected = null;
    PDF.currentStem = null;
    PDF.doc = null;
    document.getElementById('pdf-panel').innerHTML  = placeholderHtml();
    document.getElementById('data-panel').innerHTML = noSelectionHtml();
  }
}

// ════════════════════════════════════════════════════════════════════════════
// PDF panel
// ════════════════════════════════════════════════════════════════════════════
const PDF = {
  zoom: 1.25,
  grabMode: true,
  currentStem: null,
  doc: null,
  _isDown: false,
  _startX: 0,
  _startY: 0,
  _scrollLeft: 0,
  _scrollTop: 0
};

// Icon SVGs for toolbar buttons
function handToolIcon() {
  // Hand/grab icon (shown when grab mode is active)
  return `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v5"/>
    <path d="M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v11"/>
    <path d="M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8"/>
    <path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.82-2.82L9 15.66"/>
  </svg>`;
}

function textSelectIcon() {
  // Text cursor icon (shown when text selection mode is active)
  return `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <line x1="12" y1="3" x2="12" y2="21"/>
    <path d="M8 8h8"/>
    <path d="M8 16h8"/>
    <path d="M9 3h6"/>
    <path d="M9 21h6"/>
  </svg>`;
}

function fitToWidthIcon() {
  return `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
    <path d="M3 9h18"/>
    <path d="M9 9v12"/>
    <path d="M15 9v12"/>
  </svg>`;
}

async function renderPdf(result, hasPages) {
  const panel = document.getElementById('pdf-panel');
  
  // Clear any existing PDF document to prevent stale renders
  PDF.doc = null;
  
  if (PDF.currentStem !== result.stem) {
    PDF.currentStem = result.stem;
    // Use saved zoom or default
    const savedZoom = parseInt(localStorage.getItem('pdf-zoom'), 10);
    PDF.zoom = (!isNaN(savedZoom) ? savedZoom : 125) / 100;
    // Use saved grab mode preference (default to true/on)
    const savedGrabMode = localStorage.getItem('pdf-grab-mode');
    PDF.grabMode = savedGrabMode !== null ? savedGrabMode === '1' : true;
  }

  const filename = result.source_file ? result.source_file.split('/').pop() : '(unknown)';
  const pdfUrl   = `/api/invoices/${encodeURIComponent(result.stem)}/pdf`;

  if (!hasPages) {
    panel.innerHTML = `
      <div class="pdf-toolbar"><span class="pdf-filename">${esc(filename)}</span></div>
      <div class="pdf-placeholder"><p>PDF not available.</p></div>`;
    return;
  }

  panel.innerHTML = `
    <div class="pdf-toolbar">
      <span class="pdf-filename">${esc(filename)}</span>
      <div class="pdf-zoom-ctrl">
        <button class="btn-zoom" onclick="updateZoom(-0.25)" title="Zoom out">−</button>
        <span class="zoom-label">${Math.round(PDF.zoom * 100)}%</span>
        <button class="btn-zoom" onclick="updateZoom(0.25)" title="Zoom in">+</button>
        <button class="btn-zoom" onclick="fitToWidth()" title="Fit to width">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <path d="M3 9h18"/>
            <path d="M9 9v12"/>
            <path d="M15 9v12"/>
          </svg>
        </button>
        <button class="btn-zoom ${PDF.grabMode ? 'active' : ''}" id="hand-btn" onclick="toggleHandTool()" title="${PDF.grabMode ? 'Hand tool on (click to select text)' : 'Hand tool off (click to pan)'}" style="margin-left:2px;">
          ${PDF.grabMode ? handToolIcon() : textSelectIcon()}
        </button>
      </div>
    </div>
    <div class="pdf-viewer-container ${PDF.grabMode ? 'grab-mode' : ''}" id="viewer-container">
      <div id="viewer-pages" style="display:flex; flex-direction:column; gap:20px; align-items:center;"></div>
    </div>
  `;

  const container = document.getElementById('viewer-container');
  setupGrabToPan(container);

  try {
    const loadingTask = pdfjsLib.getDocument(pdfUrl);
    PDF.doc = await loadingTask.promise;
    renderPages(PDF.currentStem);
  } catch (e) {
    console.error("PDF.js loading failed", e);
    panel.innerHTML = `<div class="pdf-placeholder"><p>Failed to load PDF viewer: ${esc(e.message)}</p></div>`;
  }
}

async function renderPages(expectedStem) {
  const viewer = document.getElementById('viewer-pages');
  // Guard against stale renders - only render if stem matches (or no specific stem expected)
  if (expectedStem && PDF.currentStem !== expectedStem) return;
  if (!viewer || !PDF.doc) return;
  viewer.innerHTML = '';

  // Track if we need to update cursor based on grab mode
  const container = document.getElementById('viewer-container');
  const isGrabMode = container && container.classList.contains('grab-mode');

  for (let i = 1; i <= PDF.doc.numPages; i++) {
    const page = await PDF.doc.getPage(i);
    const viewport = page.getViewport({ scale: PDF.zoom });

    const pageDiv = document.createElement('div');
    pageDiv.className = 'page-container';
    pageDiv.style.width = viewport.width + 'px';
    pageDiv.style.height = viewport.height + 'px';
    if (isGrabMode) pageDiv.style.cursor = 'grab';
    viewer.appendChild(pageDiv);

    // Canvas layer - captures clicks when not on text
    const canvas = document.createElement('canvas');
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    canvas.style.display = 'block';
    pageDiv.appendChild(canvas);

    // Text layer - absolutely positioned over canvas
    const textLayerDiv = document.createElement('div');
    textLayerDiv.className = 'textLayer';
    textLayerDiv.style.cssText = `
      position: absolute;
      left: 0;
      top: 0;
      width: ${viewport.width}px;
      height: ${viewport.height}px;
      z-index: 2;
    `;
    pageDiv.appendChild(textLayerDiv);

    // Render PDF page to canvas
    const renderContext = { canvasContext: canvas.getContext('2d'), viewport };
    const renderTask = page.render(renderContext);
    
    // Get text content for the text layer
    const textContent = await page.getTextContent();
    
    // Wait for both rendering and text extraction
    await Promise.all([
      renderTask.promise,
      pdfjsLib.renderTextLayer({
        textContent,
        container: textLayerDiv,
        viewport,
        enhanceTextSelection: true
      }).promise
    ]);
    
    // Make sure text layer allows selection
    textLayerDiv.style.pointerEvents = 'auto';
  }
}

function updateZoom(delta) {
  const container = document.getElementById('viewer-container');
  
  // Save scroll position relative to center for zoom-to-center behavior
  let scrollRatioX = 0.5, scrollRatioY = 0.5;
  if (container) {
    const centerX = container.scrollLeft + container.clientWidth / 2;
    const centerY = container.scrollTop + container.clientHeight / 2;
    scrollRatioX = centerX / container.scrollWidth;
    scrollRatioY = centerY / container.scrollHeight;
  }
  
  PDF.zoom = Math.min(4, Math.max(0.25, PDF.zoom + delta));
  
  // Save to localStorage
  localStorage.setItem('pdf-zoom', Math.round(PDF.zoom * 100));
  
  renderPages(PDF.currentStem).then(() => {
    // Restore scroll position to maintain center point
    if (container) {
      const newCenterX = scrollRatioX * container.scrollWidth;
      const newCenterY = scrollRatioY * container.scrollHeight;
      container.scrollLeft = newCenterX - container.clientWidth / 2;
      container.scrollTop = newCenterY - container.clientHeight / 2;
    }
  });
  
  const label = document.querySelector('.zoom-label');
  if (label) label.textContent = Math.round(PDF.zoom * 100) + '%';
}

function toggleHandTool() {
  PDF.grabMode = !PDF.grabMode;
  const btn = document.getElementById('hand-btn');
  const container = document.getElementById('viewer-container');
  
  if (btn) {
    btn.classList.toggle('active', PDF.grabMode);
    btn.title = PDF.grabMode ? 'Hand tool on (click to select text)' : 'Hand tool off (click to pan)';
    // Update icon inside the button
    btn.innerHTML = PDF.grabMode ? handToolIcon() : textSelectIcon();
  }
  
  if (container) {
    container.classList.toggle('grab-mode', PDF.grabMode);
    // Update cursors on all pages
    const pages = container.querySelectorAll('.page-container');
    pages.forEach(p => p.style.cursor = PDF.grabMode ? 'grab' : '');
  }
  
  // Clear any active selection when entering grab mode
  if (PDF.grabMode) {
    window.getSelection()?.removeAllRanges();
  }
  
  // Save preference to localStorage
  localStorage.setItem('pdf-grab-mode', PDF.grabMode ? '1' : '0');
}

async function fitToWidth() {
  if (!PDF.doc) return;
  
  const container = document.getElementById('viewer-container');
  if (!container) return;
  
  // Get the first page to determine the scale
  const page = await PDF.doc.getPage(1);
  const viewport = page.getViewport({ scale: 1 });
  
  // Calculate available width (container width minus minimal padding)
  const padding = 8; // 4px on each side
  const availableWidth = container.clientWidth - padding;
  
  // Calculate scale to fit width
  const scale = Math.max(0.25, Math.min(4, availableWidth / viewport.width));
  
  // Apply the zoom
  PDF.zoom = scale;
  localStorage.setItem('pdf-zoom', Math.round(PDF.zoom * 100));
  
  // Re-render pages
  await renderPages(PDF.currentStem);
  
  // Update zoom label
  const label = document.querySelector('.zoom-label');
  if (label) label.textContent = Math.round(PDF.zoom * 100) + '%';
  
  // Scroll to top
  container.scrollTop = 0;
  container.scrollLeft = 0;
}

// ════════════════════════════════════════════════════════════════════════════
// Supplier lookup modal
// ════════════════════════════════════════════════════════════════════════════
let supplierCache = null;
let selectedSupplierId = null;
let _lookupSupplierId = null;   // set when operator picks a supplier via the lookup modal

async function openSupplierLookup() {
  // Create modal if not exists
  let modal = document.getElementById('supplier-modal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'supplier-modal';
    modal.className = 'modal-overlay hidden';
    modal.innerHTML = `
      <div class="modal-dialog" onclick="event.stopPropagation()">
        <div class="modal-header">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 7H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
          </svg>
          <h3>Select Supplier</h3>
          <button class="btn-sm" onclick="closeSupplierLookup()" style="margin-left:auto">✕</button>
        </div>
        <div class="modal-search">
          <input type="text" id="supplier-search" placeholder="Search suppliers by name, ABN, or email..." oninput="filterSuppliers()">
        </div>
        <div class="modal-body">
          <div class="supplier-list" id="supplier-list">
            <div class="modal-empty">Loading suppliers...</div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-cancel-edit" onclick="closeSupplierLookup()">Cancel</button>
          <button class="btn btn-save-edit" onclick="selectSupplier()" id="select-supplier-btn" disabled>Select Supplier</button>
        </div>
      </div>
    `;
    // Close on overlay click
    modal.addEventListener('click', closeSupplierLookup);
    document.body.appendChild(modal);
  }
  
  // Show modal
  modal.classList.remove('hidden');
  selectedSupplierId = null;
  updateSelectButton();
  
  // Focus search
  setTimeout(() => {
    const searchInput = document.getElementById('supplier-search');
    if (searchInput) {
      searchInput.value = '';
      searchInput.focus();
    }
  }, 10);
  
  // Load suppliers
  if (!supplierCache) {
    try {
      const data = await api.get('/api/admin/suppliers');
      supplierCache = data.rows || [];
    } catch (e) {
      document.getElementById('supplier-list').innerHTML = `<div class="modal-empty">Error loading suppliers: ${esc(e.message)}</div>`;
      return;
    }
  }
  
  renderSupplierList(supplierCache);
}

function closeSupplierLookup() {
  const modal = document.getElementById('supplier-modal');
  if (modal) modal.classList.add('hidden');
  selectedSupplierId = null;
}

function renderSupplierList(suppliers) {
  const list = document.getElementById('supplier-list');
  if (!suppliers.length) {
    list.innerHTML = '<div class="modal-empty">No suppliers found</div>';
    return;
  }
  
  list.innerHTML = suppliers.map(s => `
    <div class="supplier-item ${s.id === selectedSupplierId ? 'selected' : ''}" 
         data-id="${esc(s.id || '')}"
         onclick="onSupplierClick('${esc(s.id || '')}')">
      <div class="supplier-info">
        <div class="supplier-name">${esc(s.name || 'Unnamed')}</div>
        <div class="supplier-meta">${esc(s.id || '')} ${s.abn ? '• ' + esc(s.abn) : ''}</div>
      </div>
      ${s.abn ? `<div class="supplier-abn">${esc(s.abn)}</div>` : ''}
    </div>
  `).join('');
}

function onSupplierClick(id) {
  selectedSupplierId = id;
  
  // Update visual selection
  document.querySelectorAll('.supplier-item').forEach(el => {
    el.classList.toggle('selected', el.dataset.id === id);
  });
  
  updateSelectButton();
  
  // Double-click to select immediately
  if (Date.now() - (window._lastSupplierClick || 0) < 300) {
    selectSupplier();
  }
  window._lastSupplierClick = Date.now();
}

function updateSelectButton() {
  const btn = document.getElementById('select-supplier-btn');
  if (btn) btn.disabled = !selectedSupplierId;
}

function filterSuppliers() {
  const query = document.getElementById('supplier-search').value.toLowerCase().trim();
  if (!query) {
    renderSupplierList(supplierCache);
    return;
  }
  
  const filtered = supplierCache.filter(s => {
    const id = (s.id || '').toLowerCase();
    const name = (s.name || '').toLowerCase();
    const abn = (s.abn || '').toLowerCase();
    const email = (s.email || '').toLowerCase();
    const aliases = (s.aliases || '').toLowerCase();
    return id.includes(query) || name.includes(query) || abn.includes(query) || email.includes(query) || aliases.includes(query);
  });
  
  renderSupplierList(filtered);
  
  // Auto-select first result on Enter key
  document.getElementById('supplier-search').onkeydown = (e) => {
    if (e.key === 'Enter' && filtered.length > 0) {
      onSupplierClick(filtered[0].id);
      selectSupplier();
    }
  };
}

function selectSupplier() {
  if (!selectedSupplierId || !supplierCache) return;
  
  const supplier = supplierCache.find(s => s.id === selectedSupplierId);
  if (!supplier) return;
  
  // Populate the form fields
  const idInput = document.getElementById('edit-supplier_id');
  const nameInput = document.getElementById('edit-supplier_name');
  const abnInput = document.getElementById('edit-supplier_abn');
  const emailInput = document.getElementById('edit-supplier_email');
  const phoneInput = document.getElementById('edit-supplier_phone');
  const addressInput = document.getElementById('edit-supplier_address');
  
  if (idInput) idInput.value = supplier.id || '';
  if (nameInput) nameInput.value = supplier.name || '';
  if (abnInput) abnInput.value = supplier.abn || '';
  if (emailInput) emailInput.value = supplier.email || '';
  if (phoneInput) phoneInput.value = supplier.phone || '';
  if (addressInput) addressInput.value = supplier.address || '';

  // Track which supplier was picked so saveEdit() can persist the supplier_id
  _lookupSupplierId = supplier.id;

  // Close modal
  closeSupplierLookup();
  
  // Show feedback
  showToast(`Supplier updated to: ${supplier.name}`, 'success', 3000);
}

// ════════════════════════════════════════════════════════════════════════════
// Audit / History
// ════════════════════════════════════════════════════════════════════════════

const _AUDIT_ACTION_LABELS = {
  processed:          'Processed by pipeline',
  processing_failed:  'Processing failed',
  status_changed:     'Status changed',
  corrections_saved:  'Corrections saved',
  notes_updated:      'Notes updated',
  exported:           'Exported',
};

function _auditDotClass(action) {
  if (action === 'exported')           return 'exported';
  if (action === 'status_changed')     return 'status';
  if (action === 'processed' || action === 'processing_failed') return 'system';
  return 'operator';
}

function _auditDetailText(entry) {
  const d = entry.detail;
  if (!d) return '';
  if (entry.action === 'status_changed')
    return `${d.from} → ${d.to}`;
  if (entry.action === 'corrections_saved' && d.fields?.length)
    return d.fields.join(', ');
  if (entry.action === 'exported')
    return d.format ? `format: ${d.format}${d.bulk ? ', bulk' : ''}` : '';
  if (entry.action === 'processing_failed' && d.error)
    return d.error;
  return '';
}

function _fmtAuditTime(iso) {
  try {
    const d = new Date(iso);
    return d.toLocaleString(undefined, { dateStyle: 'short', timeStyle: 'short' });
  } catch { return iso; }
}

async function loadAuditLog(stem) {
  // Find or create the audit section placeholder appended after data-panel content
  const panel = document.getElementById('data-panel');
  if (!panel) return;

  // Remove any existing audit section first (panel may have been re-rendered)
  panel.querySelector('.audit-section')?.remove();

  const section = document.createElement('div');
  section.className = 'audit-section';
  section.innerHTML = `
    <button class="audit-toggle" onclick="toggleAudit(this)" aria-expanded="false">
      <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <polyline points="9 18 15 12 9 6"/>
      </svg>
      History
    </button>
    <div class="audit-timeline" hidden></div>
  `;
  panel.appendChild(section);

  try {
    const entries = await api.auditLog(stem);
    const timeline = section.querySelector('.audit-timeline');
    if (!entries.length) {
      timeline.innerHTML = '<div class="audit-meta" style="padding:4px 0">No history recorded yet.</div>';
    } else {
      timeline.innerHTML = entries.map(e => {
        const label  = _AUDIT_ACTION_LABELS[e.action] || e.action;
        const detail = _auditDetailText(e);
        const dot    = _auditDotClass(e.action);
        const actor  = e.actor !== 'system' ? ` · ${esc(e.actor)}` : '';
        return `
          <div class="audit-entry">
            <div class="audit-dot ${dot}"></div>
            <div class="audit-body">
              <div class="audit-action">${esc(label)}</div>
              <div class="audit-meta">${_fmtAuditTime(e.timestamp)}${actor}</div>
              ${detail ? `<div class="audit-detail">${esc(detail)}</div>` : ''}
            </div>
          </div>`;
      }).join('');
    }
  } catch {
    // Silently skip — audit log is non-critical
  }
}

function toggleAudit(btn) {
  const timeline = btn.nextElementSibling;
  const open = !timeline.hidden;
  timeline.hidden = open;
  btn.classList.toggle('open', !open);
  btn.setAttribute('aria-expanded', String(!open));
}

// ════════════════════════════════════════════════════════════════════════════
// Create Supplier from edit form
// ════════════════════════════════════════════════════════════════════════════
async function openCreateSupplierModal() {
  const name    = (document.getElementById('edit-supplier_name')?.value    || '').trim();
  const abn     = (document.getElementById('edit-supplier_abn')?.value     || '').trim();
  const email   = (document.getElementById('edit-supplier_email')?.value   || '').trim();
  const phone   = (document.getElementById('edit-supplier_phone')?.value   || '').trim();
  const address = (document.getElementById('edit-supplier_address')?.value || '').trim();

  if (!name) {
    showToast('Supplier name is required before creating a supplier record.', 'error');
    return;
  }

  // Load supplier cache if not already loaded (reuses existing lookup cache)
  if (!supplierCache) {
    try {
      const data = await api.get('/api/admin/suppliers');
      supplierCache = data.rows || [];
    } catch (_) { supplierCache = []; }
  }

  // Client-side duplicate check (non-blocking)
  let duplicateWarning = null;
  const abnClean = abn.replace(/\s/g, '');
  if (abnClean) {
    const match = supplierCache.find(s => s.abn && s.abn.replace(/\s/g, '') === abnClean);
    if (match) duplicateWarning = `A supplier with this ABN already exists: ${match.name} (${match.id})`;
  }
  if (!duplicateWarning) {
    const match = supplierCache.find(s => s.name && s.name.trim().toLowerCase() === name.toLowerCase());
    if (match) duplicateWarning = `A supplier with this name already exists (${match.id})`;
  }

  const existing = document.getElementById('create-supplier-modal');
  if (existing) existing.remove();

  const modal = document.createElement('div');
  modal.id = 'create-supplier-modal';
  modal.className = 'modal-overlay';

  const row = (label, val) =>
    `<div class="kv-label">${esc(label)}</div><div class="kv-value">${val ? esc(val) : '<span style="color:var(--muted)">—</span>'}</div>`;

  modal.innerHTML = `
    <div class="modal-box" style="max-width:460px">
      <div class="modal-header">
        <span style="font-weight:600;font-size:14px">Create New Supplier</span>
        <button class="btn-sm" onclick="document.getElementById('create-supplier-modal').remove()" style="margin-left:auto">✕</button>
      </div>
      ${duplicateWarning ? `<div class="modal-warning">⚠ ${esc(duplicateWarning)}</div>` : ''}
      <div class="modal-body" style="padding:16px">
        <div class="kv-grid" style="row-gap:6px">
          ${row('Name', name)}
          ${row('ABN / Tax ID', abn)}
          ${row('Email', email)}
          ${row('Phone', phone)}
          ${row('Address', address)}
        </div>
        <p class="modal-note">A new supplier record will be created with an auto-assigned ID. The supplier will be available for matching on the next pipeline run.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-cancel-edit" onclick="document.getElementById('create-supplier-modal').remove()">Cancel</button>
        <button class="btn btn-save-edit" id="confirm-create-supplier-btn">${duplicateWarning ? 'Create Anyway' : 'Create Supplier'}</button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
  modal.onclick = e => { if (e.target === modal) modal.remove(); };

  document.getElementById('confirm-create-supplier-btn').onclick =
    () => confirmCreateSupplier({ name, abn, email, phone, address });
}

async function confirmCreateSupplier(data) {
  const modal = document.getElementById('create-supplier-modal');
  const btn = document.getElementById('confirm-create-supplier-btn');
  if (btn) { btn.disabled = true; btn.textContent = 'Creating…'; }

  try {
    const result = await fetch('/api/suppliers/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    }).then(async r => {
      if (!r.ok) { const e = await r.json(); throw new Error(e.detail || r.status); }
      return r.json();
    });

    modal?.remove();
    supplierCache = null; // invalidate so next lookup shows the new record
    showToast(`Supplier created: ${result.id}`, 'success', 4000);
  } catch (e) {
    if (btn) { btn.disabled = false; btn.textContent = 'Create Supplier'; }
    showToast(`Failed to create supplier: ${e.message}`, 'error');
  }
}

// ════════════════════════════════════════════════════════════════════════════
// PO Lines Lookup Panel (for correcting line items against PO)
// ════════════════════════════════════════════════════════════════════════════
let poLinesCache = null;
let selectedInvoiceRowIndex = null;

async function openPOLinesPanel(poNumber) {
  // Create panel if not exists
  let panel = document.getElementById('po-lines-panel');
  if (!panel) {
    panel = document.createElement('div');
    panel.id = 'po-lines-panel';
    panel.className = 'po-lines-panel';
    document.body.appendChild(panel);
  }
  
  const selectedRowInfo = selectedInvoiceRowIndex !== null ? `• Row ${selectedInvoiceRowIndex + 1} selected` : '• Click a row below to select';
  
  panel.innerHTML = `
    <div class="po-lines-resize-handle" id="po-resize-handle"></div>
    <div class="po-lines-header">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
        <polyline points="14 2 14 8 20 8"/>
      </svg>
      <h4>Purchase Order Lines</h4>
      <span class="po-number">${esc(poNumber)}</span>
      <span id="po-selected-row" style="font-size: 11px; color: var(--accent); font-weight: 500;">${selectedRowInfo}</span>
      <button class="btn-sm po-lines-close" onclick="closePOLinesPanel()">✕</button>
    </div>
    <div class="po-lines-content" id="po-lines-content">
      <div class="po-lines-empty">Loading PO lines...</div>
    </div>
  `;
  
  // Set up resize handle
  setupPOResizeHandle(panel);
  
  // Show panel
  panel.classList.add('visible');
  
  // Reset selection
  selectedInvoiceRowIndex = null;
  highlightSelectedRow();
  
  // Load PO lines
  if (!poLinesCache) {
    try {
      const data = await api.get('/api/admin/purchase_order_lines');
      poLinesCache = data.rows || [];
    } catch (e) {
      document.getElementById('po-lines-content').innerHTML = 
        `<div class="po-lines-empty">Error loading PO lines: ${esc(e.message)}</div>`;
      return;
    }
  }
  
  // Filter by PO number
  const poLines = poLinesCache.filter(line => line.po_number === poNumber);
  
  if (!poLines.length) {
    document.getElementById('po-lines-content').innerHTML = 
      `<div class="po-lines-empty">No lines found for PO ${esc(poNumber)}</div>`;
    return;
  }
  
  renderPOLines(poLines);
}

function closePOLinesPanel() {
  const panel = document.getElementById('po-lines-panel');
  if (panel) panel.classList.remove('visible');
  selectedInvoiceRowIndex = null;
  highlightSelectedRow();
}

// Close PO panel on Escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    const panel = document.getElementById('po-lines-panel');
    if (panel && panel.classList.contains('visible')) {
      closePOLinesPanel();
    }
  }
});

// Set up resize handle for PO panel
function setupPOResizeHandle(panel) {
  const handle = panel.querySelector('#po-resize-handle');
  if (!handle) return;
  
  let isResizing = false;
  let startY = 0;
  let startHeight = 0;
  
  handle.addEventListener('mousedown', (e) => {
    isResizing = true;
    startY = e.clientY;
    startHeight = panel.offsetHeight;
    handle.classList.add('dragging');
    document.body.style.cursor = 'ns-resize';
    document.body.style.userSelect = 'none';
    e.preventDefault();
  });
  
  window.addEventListener('mousemove', (e) => {
    if (!isResizing) return;
    
    const deltaY = e.clientY - startY;
    const newHeight = Math.max(180, Math.min(window.innerHeight * 0.6, startHeight + deltaY));
    panel.style.height = newHeight + 'px';
  });
  
  window.addEventListener('mouseup', () => {
    if (!isResizing) return;
    isResizing = false;
    handle.classList.remove('dragging');
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
    
    // Save preference
    localStorage.setItem('po-panel-height', panel.style.height);
  });
}

// Restore saved panel height on load
(function restorePOResizeHeight() {
  const savedHeight = localStorage.getItem('po-panel-height');
  if (savedHeight) {
    const style = document.createElement('style');
    style.textContent = `#po-lines-panel { height: ${savedHeight}; }`;
    document.head.appendChild(style);
  }
})();

function renderPOLines(poLines) {
  const content = document.getElementById('po-lines-content');
  
  // Build table
  const rows = poLines.map((line, idx) => {
    const isMatched = isPOLineAlreadyUsed(line);
    return `<tr class="${isMatched ? 'matched' : ''}" data-idx="${idx}">
      <td class="po-sku">${esc(line.sku || '—')}</td>
      <td>${esc((line.description || '').substring(0, 40))}${(line.description || '').length > 40 ? '...' : ''}</td>
      <td class="mono">${line.quantity || ''}</td>
      <td class="mono">${line.total || ''}</td>
      <td>
        <div class="po-lines-actions">
          <button class="btn-po-copy sku-only" onclick="copyPOField('${esc(line.sku || '')}', 'sku')" 
                  ${!line.sku ? 'disabled' : ''} title="Copy SKU only">
            SKU
          </button>
          <button class="btn-po-copy" onclick="copyPOLine(${idx})" title="Copy all fields to selected row">
            Copy All
          </button>
        </div>
      </td>
    </tr>`;
  }).join('');
  
  content.innerHTML = `
    <div style="margin-bottom: 8px; font-size: 11px; color: var(--muted);">
      Select a row in the invoice line items table below, then click Copy to populate it.
    </div>
    <table class="po-lines-table">
      <thead>
        <tr>
          <th>SKU</th>
          <th>Description</th>
          <th>Qty</th>
          <th>Total</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

function isPOLineAlreadyUsed(poLine) {
  // Check if this PO line's SKU is already in the invoice line items
  if (!poLine.sku) return false;
  return S.editLineItems.some(item => item.sku === poLine.sku);
}

function copyPOField(value, field) {
  if (!selectedInvoiceRowIndex !== null && selectedInvoiceRowIndex < 0) {
    showToast('Please select a row in the invoice line items table first', 'error', 3000);
    return;
  }
  
  // First sync current DOM state
  syncEditLineItemsFromDOM();
  
  // Update the specific field
  if (!S.editLineItems[selectedInvoiceRowIndex]) {
    showToast('Invalid row selected', 'error');
    return;
  }
  
  S.editLineItems[selectedInvoiceRowIndex][field] = value;
  
  // Re-render
  renderEditLineItems();
  highlightSelectedRow();
  
  showToast(`Copied ${field} to row ${selectedInvoiceRowIndex + 1}`, 'success', 2000);
}

function copyPOLine(poLineIdx) {
  if (selectedInvoiceRowIndex === null || selectedInvoiceRowIndex < 0) {
    showToast('Please select a row in the invoice line items table first (click on it)', 'error', 3000);
    return;
  }
  
  // Find the PO line data
  const poNumber = document.querySelector('.po-lines-header .po-number')?.textContent;
  if (!poNumber) return;
  
  const poLines = poLinesCache.filter(line => line.po_number === poNumber);
  const poLine = poLines[poLineIdx];
  if (!poLine) return;
  
  // First sync current DOM state
  syncEditLineItemsFromDOM();
  
  // Update the invoice line item
  if (!S.editLineItems[selectedInvoiceRowIndex]) {
    // Add a new row if needed
    while (S.editLineItems.length <= selectedInvoiceRowIndex) {
      S.editLineItems.push({ line_number: S.editLineItems.length + 1 });
    }
  }
  
  const item = S.editLineItems[selectedInvoiceRowIndex];
  item.sku = poLine.sku || item.sku || '';
  item.description = poLine.description || item.description || '';
  item.quantity = poLine.quantity || item.quantity || null;
  item.unit_price = poLine.unit_price || item.unit_price || null;
  item.line_total = poLine.total || item.line_total || null;
  
  // Re-render
  renderEditLineItems();
  highlightSelectedRow();
  updateEditLineItemCount();
  
  showToast(`Copied PO line to row ${selectedInvoiceRowIndex + 1}`, 'success', 2000);
  
  // Auto-advance to next row for convenience
  if (selectedInvoiceRowIndex < S.editLineItems.length - 1) {
    selectedInvoiceRowIndex++;
    highlightSelectedRow();
    // Scroll the new row into view
    const rows = document.querySelectorAll('#edit-li-tbody tr');
    if (rows[selectedInvoiceRowIndex]) {
      rows[selectedInvoiceRowIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }
}

// Set up delegated click handler for line item row selection
document.addEventListener('click', (e) => {
  // Only handle clicks in edit mode
  if (!S.editing) return;
  
  const tbody = document.getElementById('edit-li-tbody');
  if (!tbody) return;
  
  // Check if click was inside the tbody
  if (!tbody.contains(e.target)) return;
  
  // Don't select if clicking on an input/button
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON' || e.target.closest('button')) {
    return;
  }
  
  // Find the row that was clicked
  const row = e.target.closest('tr');
  if (!row) return;
  
  // Get the index of this row
  const rows = Array.from(tbody.children);
  const idx = rows.indexOf(row);
  if (idx === -1) return;
  
  // Toggle selection
  if (selectedInvoiceRowIndex === idx) {
    selectedInvoiceRowIndex = null; // deselect
  } else {
    selectedInvoiceRowIndex = idx;
  }
  
  highlightSelectedRow();
});

function highlightSelectedRow() {
  const tbody = document.getElementById('edit-li-tbody');
  if (!tbody) return;
  
  const rows = tbody.querySelectorAll('tr');
  rows.forEach((row, idx) => {
    row.classList.toggle('selected', idx === selectedInvoiceRowIndex);
  });
  
  // Update PO panel header if visible
  const selectedRowEl = document.getElementById('po-selected-row');
  if (selectedRowEl) {
    selectedRowEl.textContent = selectedInvoiceRowIndex !== null 
      ? `• Row ${selectedInvoiceRowIndex + 1} selected` 
      : '• Click a row below to select';
  }
}

function updateEditLineItemCount() {
  const el = document.getElementById('edit-li-count');
  if (el) el.textContent = S.editLineItems.length;
}

function setupGrabToPan(container) {
  let isDragging = false;
  let startX, startY, startScrollLeft, startScrollTop;

  container.addEventListener('mousedown', (e) => {
    if (!PDF.grabMode) return;
    // Don't grab if clicking on toolbar buttons/controls
    if (e.target.closest('button') || e.target.closest('input')) return;
    
    isDragging = true;
    startX = e.clientX;
    startY = e.clientY;
    startScrollLeft = container.scrollLeft;
    startScrollTop = container.scrollTop;
    container.classList.add('grabbing');
    e.preventDefault();
  });

  window.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    container.scrollLeft = startScrollLeft - dx;
    container.scrollTop = startScrollTop - dy;
  });

  window.addEventListener('mouseup', () => {
    if (!isDragging) return;
    isDragging = false;
    container.classList.remove('grabbing');
  });

  // Spacebar + drag support (temporary grab mode)
  let spacePressed = false;
  document.addEventListener('keydown', (e) => {
    if (e.code === 'Space' && !e.repeat && !isTypingInInput()) {
      spacePressed = true;
      container.classList.add('grab-mode');
      const pages = container.querySelectorAll('.page-container');
      pages.forEach(p => p.style.cursor = 'grab');
      e.preventDefault();
    }
  });

  document.addEventListener('keyup', (e) => {
    if (e.code === 'Space') {
      spacePressed = false;
      if (!PDF.grabMode) {
        container.classList.remove('grab-mode');
        const pages = container.querySelectorAll('.page-container');
        pages.forEach(p => p.style.cursor = '');
      }
    }
  });

  // Middle-click pan (always works)
  container.addEventListener('mousedown', (e) => {
    if (e.button === 1) {
      e.preventDefault();
      isDragging = true;
      startX = e.clientX;
      startY = e.clientY;
      startScrollLeft = container.scrollLeft;
      startScrollTop = container.scrollTop;
      container.classList.add('grabbing');
    }
  });

  function isTypingInInput() {
    const active = document.activeElement;
    return active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable);
  }
}

// ════════════════════════════════════════════════════════════════════════════
// Data panel
// ════════════════════════════════════════════════════════════════════════════
function renderData(result) {
  S.currentResult = result;
  const { inv, sup, corr } = mergeCorrections(result);
  const bill  = inv.bill_to   || {};
  const ms    = result.matched_supplier || null;
  const mp    = result.matched_po       || null;
  const disc  = result.discrepancies    || [];
  const errs  = disc.filter(d => d.severity === 'error');
  const warns = disc.filter(d => d.severity === 'warning');

  const statusCls = errs.length  > 0 ? 'err' : warns.length > 0 ? 'warn' : 'ok';
  const statusIcon= errs.length  > 0 ? '✗' : warns.length > 0 ? '⚠' : '✓';
  const statusTxt = errs.length  > 0
    ? `${errs.length} error${errs.length > 1 ? 's' : ''}, ${warns.length} warning${warns.length !== 1 ? 's' : ''}`
    : warns.length > 0
    ? `${warns.length} warning${warns.length > 1 ? 's' : ''}`
    : 'All checks passed';

  const totalDisplay = inv.total != null ? `${inv.currency || ''} ${fmt(inv.total)}`.trim() : null;

  document.getElementById('data-panel').innerHTML = `

    ${actionBarHtml(result)}

    <!-- Extraction quality banner -->
    <div class="status-banner ${statusCls}">
      <span style="font-size:16px">${statusIcon}</span>
      <span>${statusTxt}</span>
      ${result.processing_time_seconds != null
        ? `<span class="meta">Processed in ${result.processing_time_seconds}s · ${esc(result.llm_model_used || '')}</span>`
        : ''}
    </div>

    <!-- Invoice details -->
    <div class="card">
      <div class="card-header">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
          <line x1="1" y1="10" x2="23" y2="10"/>
        </svg>
        Invoice Details
      </div>
      <div class="kv-grid">
        ${kv('Invoice Number', inv.invoice_number, !!corr.invoice_number)}
        ${kv('Invoice Date',   inv.invoice_date,   !!corr.invoice_date)}
        ${kv('Due Date',       inv.due_date,        !!corr.due_date)}
        ${kv('PO Number',      inv.po_number,       !!corr.po_number)}
        ${kv('Currency',       inv.currency,        !!corr.currency)}
        ${kv('Subtotal',       inv.subtotal   != null ? fmtMoney(inv.currency, inv.subtotal)   : null, !!corr.subtotal)}
        ${kv('Tax',            inv.tax_amount != null ? fmtMoney(inv.currency, inv.tax_amount) : null, !!corr.tax_amount)}
        ${kvBig('Total',       totalDisplay, !!corr.total)}
      </div>
    </div>

    <!-- Supplier -->
    <div class="card">
      <div class="card-header">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 7H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
          <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
        </svg>
        Supplier
        ${ms
          ? `<span class="badge ok">${esc(ms.supplier_name)}</span>`
          : `<span class="badge warn">Unmatched</span>`}
      </div>
      <div class="kv-grid">
        ${kv('Extracted Name', sup.name,  !!corr.supplier_name)}
        ${kv('ABN / Tax ID',   sup.abn,   !!corr.supplier_abn)}
        ${kv('Email',          sup.email, !!corr.supplier_email)}
        ${kv('Phone',          sup.phone, !!corr.supplier_phone)}
        ${kv('Supplier ID',    corr.corrected_supplier_id || (ms && ms.supplier_id) || '—', !!corr.corrected_supplier_id)}
        ${ms && !corr.corrected_supplier_id ? kv('Match Detail', formatMatchDetail(ms)) : ''}
        ${corr.corrected_supplier_id && ms ? kvStrike('Original Match', formatMatchDetail(ms)) : ''}
        ${sup.address ? kvWide('Address', sup.address, !!corr.supplier_address) : ''}
      </div>
    </div>

    ${bill.name || bill.address ? `
    <!-- Bill To -->
    <div class="card">
      <div class="card-header">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
          <polyline points="9 22 9 12 15 12 15 22"/>
        </svg>
        Bill To
      </div>
      <div class="kv-grid">
        ${kv('Name',  bill.name)}
        ${kv('Email', bill.email)}
        ${bill.address ? kvWide('Address', bill.address) : ''}
      </div>
    </div>` : ''}

    ${lineItemsCard(inv, mp, corr)}
    ${mp ? poMatchCard(mp) : ''}
    ${discCard(disc)}
    ${notesCard(result)}
    ${customFieldsCard(inv)}

    <div class="meta-footer">
      <span>📁 ${esc((result.source_file || '').split('/').pop() || '—')}</span>
      ${result.processed_at ? `<span>🕐 ${fmtDate(result.processed_at)}</span>` : ''}
      ${result.exported_at  ? `<span>✅ Exported ${fmtDate(result.exported_at)}</span>` : ''}
      ${result.raw_text_length ? `<span>📝 ${result.raw_text_length.toLocaleString()} chars</span>` : ''}
      ${result.llm_model_used  ? `<span>🤖 ${esc(result.llm_model_used)}</span>` : ''}
    </div>
  `;
}

// ════════════════════════════════════════════════════════════════════════════
// Action bar (workflow controls)
// ════════════════════════════════════════════════════════════════════════════
function actionBarHtml(result) {
  const status = result.status || 'needs_review';

  const pillLabel = {
    needs_review: '⚠ Needs Review',
    ready:        '✓ Ready',
    exported:     '↗ Exported',
  }[status] || status;

  let actions = '';
  if (status === 'exported') {
    actions = `<span class="btn-exported-label">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="20 6 9 17 4 12"/>
      </svg>
      Exported ${result.exported_at ? fmtDate(result.exported_at) : ''}
    </span>`;
  } else {
    // Reprocess button
    actions += `<button class="btn btn-reprocess" onclick="reprocessInvoice('${esc(result.stem)}')">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <polyline points="1 4 1 10 7 10"/>
        <path d="M3.51 15a9 9 0 1 0 .49-4"/>
      </svg>
      Reprocess
    </button>`;
    // Delete button
    actions += `<button class="btn btn-delete" onclick="deleteInvoice('${esc(result.stem)}')">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <polyline points="3 6 5 6 21 6"/>
        <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
        <path d="M10 11v6"/><path d="M14 11v6"/>
        <path d="M9 6V4h6v2"/>
      </svg>
      Delete
    </button>`;
    // Edit button
    actions += `<button class="btn btn-edit" onclick="startEdit(S.currentResult)">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
      </svg>
      Edit
    </button>`;
    // Visual separator between destructive/edit and workflow actions
    actions += `<div class="action-sep"></div>`;
    // Flag / unflag button
    if (status === 'ready') {
      actions += `<button class="btn btn-flag" onclick="flagInvoice('${esc(result.stem)}')">
        ⚑ Flag for Review
      </button>`;
    } else {
      actions += `<button class="btn btn-flag" onclick="clearFlag('${esc(result.stem)}')">
        ✓ Mark Ready
      </button>`;
    }
    // Export button
    actions += `<button class="btn btn-export" onclick="exportInvoice('${esc(result.stem)}')">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="17 8 12 3 7 8"/>
        <line x1="12" y1="3" x2="12" y2="15"/>
      </svg>
      Export Invoice
    </button>`;
  }

  return `<div class="action-bar">
    <div class="status-pill ${status}">
      <div class="status-pill-dot"></div>
      ${pillLabel}
    </div>
    <div class="action-btns">${actions}</div>
  </div>`;
}

// ════════════════════════════════════════════════════════════════════════════
// Workflow actions
// ════════════════════════════════════════════════════════════════════════════
async function exportInvoice(stem) {
  const btn = document.querySelector('.btn-export');
  if (btn) { btn.disabled = true; btn.textContent = 'Exporting…'; }
  const prevIndex = S.filtered.findIndex(inv => inv.stem === stem);
  let success = false;
  try {
    await api.export(stem);
    showToast(`Exported: ${stem}`, 'success');
    success = true;
    await poll();               // refreshes S.filtered and sidebar counts
    await autoAdvance(stem, prevIndex);
  } catch (e) {
    showToast('Export failed: ' + e.message, 'error');
  } finally {
    // Reset button state if export failed or if button is still in DOM
    // (On success, autoAdvance usually re-renders, but check just in case)
    if (btn && document.contains(btn) && (!success || btn.disabled)) {
      btn.disabled = false;
      btn.textContent = 'Export Invoice';
    }
  }
}

async function flagInvoice(stem) {
  const prevIndex = S.filtered.findIndex(inv => inv.stem === stem);
  try {
    await api.setStatus(stem, 'needs_review');
    await poll();
    await autoAdvance(stem, prevIndex);
  } catch (e) {
    alert('Failed to flag invoice: ' + e.message);
  }
}

async function clearFlag(stem) {
  const prevIndex = S.filtered.findIndex(inv => inv.stem === stem);
  try {
    await api.setStatus(stem, 'ready');
    await poll();
    await autoAdvance(stem, prevIndex);
  } catch (e) {
    alert('Failed to update status: ' + e.message);
  }
}

async function exportAll() {
  const count = S.filtered.length;
  if (!count) return;
  if (!confirm(`Export all ${count} ready invoice${count !== 1 ? 's' : ''}? This will move their PDFs to the export folder.`)) return;

  const btn = document.getElementById('export-all-btn');
  if (btn) { btn.disabled = true; btn.textContent = `Exporting ${count}…`; }

  try {
    const result = await api.bulkExport();
    await poll();  // refresh counts + list (ready queue now empty)
    S.selected = null;
    document.getElementById('pdf-panel').innerHTML  = placeholderHtml();
    document.getElementById('data-panel').innerHTML = `<div class="no-selection">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <polyline points="20 6 9 17 4 12"/>
      </svg>
      <h3>${result.exported} invoice${result.exported !== 1 ? 's' : ''} exported</h3>
      <p>All ready invoices have been moved to the export folder.</p>
      ${result.errors && result.errors.length ? `<p style="color:var(--err);font-size:11px;margin-top:8px">${result.errors.length} error${result.errors.length !== 1 ? 's' : ''} — check logs.</p>` : ''}
    </div>`;
  } catch (e) {
    showToast('Bulk export failed: ' + e.message, 'error');
    if (btn) { btn.disabled = false; btn.textContent = `Export All Ready (${count})`; }
  }
}

async function reprocessInvoice(stem) {
  if (!confirm('Reprocess this invoice? It will be removed from the list and re-submitted to the LLM on the next pipeline cycle. It will reappear once processing is complete.')) return;
  const btn = document.querySelector('.btn-reprocess');
  if (btn) { btn.disabled = true; btn.textContent = 'Queuing…'; }
  const prevIndex = S.filtered.findIndex(inv => inv.stem === stem);
  try {
    await api.reprocess(stem);
    await poll();               // status resets to needs_review, list updates
    await autoAdvance(stem, prevIndex);
  } catch (e) {
    alert('Reprocess failed: ' + e.message);
    if (btn) { btn.disabled = false; }
  }
}

async function deleteInvoice(stem) {
  if (!confirm('Delete this invoice? The PDF and all extracted data will be permanently removed. This cannot be undone.')) return;
  const btn = document.querySelector('.btn-delete');
  if (btn) { btn.disabled = true; btn.textContent = 'Deleting…'; }
  const prevIndex = S.filtered.findIndex(inv => inv.stem === stem);
  try {
    await api.deleteInvoice(stem);
    await poll();               // record removed from list
    await autoAdvance(stem, prevIndex);
  } catch (e) {
    alert('Delete failed: ' + e.message);
    if (btn) { btn.disabled = false; }
  }
}

async function saveNotes(stem) {
  const ta = document.getElementById('notes-textarea');
  if (!ta) return;
  const notes = ta.value;
  try {
    await api.saveNotes(stem, notes);
    ta.style.borderColor = 'var(--ok)';
    setTimeout(() => { if (ta) ta.style.borderColor = ''; }, 1500);
  } catch (e) {
    alert('Failed to save notes: ' + e.message);
  }
}

// ════════════════════════════════════════════════════════════════════════════
// Notes card
// ════════════════════════════════════════════════════════════════════════════
function notesCard(result) {
  const notes  = result.notes || '';
  const stem   = result.stem  || '';
  if (result.status === 'exported' && !notes) return '';

  return `<div class="card">
    <div class="card-header">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
      </svg>
      Operator Notes
    </div>
    <textarea id="notes-textarea" class="notes-area"
      placeholder="Add notes about this invoice…"
      ${result.status === 'exported' ? 'readonly' : ''}
    >${esc(notes)}</textarea>
    ${result.status !== 'exported' ? `
    <div class="notes-save-row">
      <button class="btn-sm" onclick="saveNotes('${esc(stem)}')">Save Notes</button>
    </div>` : ''}
  </div>`;
}

// ════════════════════════════════════════════════════════════════════════════
// Custom fields card
// ════════════════════════════════════════════════════════════════════════════
function customFieldsCard(inv) {
  const cf = inv.custom_fields || {};
  const title = inv.custom_fields_title || 'Custom Fields';
  const entries = Object.entries(cf).filter(([, v]) => v != null && String(v).trim() !== '');
  if (!entries.length) return '';

  const items = entries.map(([k, v]) => {
    // Convert snake_case key to Title Case as a fallback label
    const label = k.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    return `<div class="kv-item">
      <div class="kv-label">${esc(label)}</div>
      <div class="kv-value">${esc(String(v))}</div>
    </div>`;
  }).join('');

  return `<div class="card">
    <div class="card-header">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
      ${esc(title)}
    </div>
    <div class="kv-grid">${items}</div>
  </div>`;
}

// ════════════════════════════════════════════════════════════════════════════
// Card renderers (unchanged)
// ════════════════════════════════════════════════════════════════════════════
function lineItemsCard(inv, mp, corr={}) {
  const items = inv.line_items || [];
  const liCorrected = !!corr.line_items;
  if (!items.length) {
    return `<div class="card">
      <div class="card-header">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/>
          <line x1="8" y1="18" x2="21" y2="18"/>
          <line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/>
          <line x1="3" y1="18" x2="3.01" y2="18"/>
        </svg>
        Line Items
        <span class="badge muted">None extracted</span>
        ${liCorrected ? '<span class="corrected-tag" style="margin-left:4px">edited</span>' : ''}
      </div>
    </div>`;
  }

  const matchMap = {};
  if (mp && mp.line_matches) {
    mp.line_matches.forEach(m => { if (m.invoice_line_index != null) matchMap[m.invoice_line_index] = m; });
  }

  const hasSku   = items.some(i => i.sku);
  const hasMatch = Object.keys(matchMap).length > 0;

  const rows = items.map((item, idx) => {
    const match  = matchMap[idx];
    // Determine match status: not matched to PO, matched with mismatch, or fully matched
    let matchStatus = 'none';
    let matchText = '—';
    if (match) {
      if (!match.matched) {
        // No PO line found for this invoice line
        matchStatus = 'none';
        matchText = '—';
      } else if (match.price_matches && match.quantity_matches) {
        // Fully matched
        matchStatus = 'ok';
        matchText = '✓';
      } else {
        // Matched to PO line but price or qty mismatch
        matchStatus = 'warn';
        matchText = '⚠ Mismatch';
      }
    }
    const lineTotal = item.total ?? item.line_total;  // 'total' is canonical; 'line_total' is legacy
    const totalCell = lineTotal != null
      ? `${fmt(lineTotal)}${item.total_computed ? '<span title="Calculated from qty × unit price" style="font-size:9px;color:var(--muted);margin-left:3px">calc</span>' : ''}`
      : '—';
    return `<tr>
      ${hasSku ? `<td class="sku mono">${esc(item.sku || '')}</td>` : ''}
      <td>${esc(item.description || '—')}</td>
      <td class="mono">${item.quantity   != null ? item.quantity   : '—'}</td>
      <td class="mono">${item.unit_price != null ? fmt(item.unit_price) : '—'}</td>
      <td class="mono">${totalCell}</td>
      ${hasMatch ? `<td class="match-${matchStatus}">${matchText}</td>` : ''}
    </tr>`;
  }).join('');

  const totalRow = inv.total != null ? `
    <tr class="total-row">
      ${hasSku ? '<td></td>' : ''}
      <td colspan="3" style="text-align:right;padding-right:12px">Total</td>
      <td class="mono">${fmt(inv.total)}</td>
      ${hasMatch ? '<td></td>' : ''}
    </tr>` : '';

  return `<div class="card scroll-card line-items-card">
    <div class="card-header">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/>
        <line x1="8" y1="18" x2="21" y2="18"/>
        <line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/>
        <line x1="3" y1="18" x2="3.01" y2="18"/>
      </svg>
      Line Items
      <span class="badge info">${items.length}</span>
      ${liCorrected ? '<span class="corrected-tag" style="margin-left:4px">edited</span>' : ''}
    </div>
    <div class="card-scroll">
      <table class="items-table">
        <thead><tr>
          ${hasSku ? '<th>SKU</th>' : ''}
          <th>Description</th><th>Qty</th><th>Unit Price</th><th>Total</th>
          ${hasMatch ? '<th>PO Match</th>' : ''}
        </tr></thead>
        <tbody>${rows}${totalRow}</tbody>
      </table>
    </div>
  </div>`;
}

function poMatchCard(mp) {
  const lineMatches = mp.line_matches || [];
  // Count only successfully matched lines (matched === true)
  const matchedCount = lineMatches.filter(m => m.matched).length;
  const totalLines = lineMatches.length;
  const unmatched = mp.unmatched_invoice_lines || [];
  
  const badgeCls  = unmatched.length > 0 ? 'warn' : 'ok';
  const badgeTxt  = unmatched.length > 0 ? `${unmatched.length} unmatched` : `${matchedCount} matched`;

  return `<div class="card scroll-card disc-card">
    <div class="card-header">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="9 11 12 14 22 4"/>
        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
      </svg>
      PO Match
      <span class="badge ${badgeCls}">${esc(badgeTxt)}</span>
    </div>
    <div class="kv-grid">
      ${kv('PO Number',   mp.po_number)}
      ${kv('Lines Matched', totalLines > 0 ? matchedCount + ' of ' + totalLines : null)}
      ${kv('PO Total',    mp.po_total != null ? fmt(mp.po_total) : null)}
      ${kv('Amount Diff', mp.total_difference != null ? fmt(mp.total_difference) : null)}
    </div>
    ${unmatched.length ? `
    <div style="padding:10px 16px;border-top:1px solid var(--border)">
      <div class="kv-label" style="margin-bottom:6px">Unmatched Invoice Lines</div>
      ${unmatched.map(u => `<div style="font-size:12px;color:var(--warn);padding:2px 0">⚠ Line ${u + 1}</div>`).join('')}
    </div>` : ''}
  </div>`;
}

function discCard(disc) {
  if (!disc.length) {
    return `<div class="card">
      <div class="card-header">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
          <line x1="12" y1="9" x2="12" y2="13"/>
          <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
        Discrepancies
        <span class="badge ok">None ✓</span>
      </div>
    </div>`;
  }

  const errs  = disc.filter(d => d.severity === 'error').length;
  const warns = disc.filter(d => d.severity === 'warning').length;
  const label = [errs ? `${errs} error${errs>1?'s':''}` : '', warns ? `${warns} warning${warns>1?'s':''}` : ''].filter(Boolean).join(', ');

  const items = disc.map(d => {
    const cls  = d.severity === 'error' ? 'err' : d.severity === 'warning' ? 'warn' : 'info';
    const icon = d.severity === 'error' ? '✗'   : d.severity === 'warning' ? '!'   : 'i';
    return `<div class="disc-item">
      <div class="disc-icon ${cls}">${icon}</div>
      <div class="disc-body">
        ${d.field ? `<div class="disc-field">${esc(d.field)}</div>` : ''}
        <div class="disc-desc">${esc(d.description || '')}</div>
      </div>
    </div>`;
  }).join('');

  return `<div class="card scroll-card disc-card">
    <div class="card-header">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
        <line x1="12" y1="9" x2="12" y2="13"/>
        <line x1="12" y1="17" x2="12.01" y2="17"/>
      </svg>
      Discrepancies
      <span class="badge ${errs > 0 ? 'err' : 'warn'}">${label}</span>
    </div>
    <div class="card-scroll">
      <div class="disc-list">${items}</div>
    </div>
  </div>`;
}

// ════════════════════════════════════════════════════════════════════════════
// Template helpers
// ════════════════════════════════════════════════════════════════════════════
function kv(label, value, corrected=false) {
  const tag = corrected ? `<span class="corrected-tag">edited</span>` : '';
  const display = value != null && value !== ''
    ? `<div class="kv-value">${esc(String(value))}${tag}</div>`
    : `<div class="kv-value missing">—${tag}</div>`;
  return `<div class="kv-item"><div class="kv-label">${esc(label)}</div>${display}</div>`;
}
function kvBig(label, value, corrected=false) {
  const tag = corrected ? `<span class="corrected-tag">edited</span>` : '';
  const display = value != null && value !== ''
    ? `<div class="kv-value large">${esc(String(value))}${tag}</div>`
    : `<div class="kv-value missing">—${tag}</div>`;
  return `<div class="kv-item"><div class="kv-label">${esc(label)}</div>${display}</div>`;
}
function kvWide(label, value, corrected=false) {
  const tag = corrected ? `<span class="corrected-tag">edited</span>` : '';
  return `<div class="kv-item" style="grid-column:1/-1;border-right:none">
    <div class="kv-label">${esc(label)}</div>
    <div class="kv-value">${esc(String(value ?? ''))}${tag}</div>
  </div>`;
}
function kvStrike(label, value) {
  return `<div class="kv-item">
    <div class="kv-label">${esc(label)}</div>
    <div class="kv-value" style="text-decoration:line-through;opacity:0.6;color:var(--muted)">${esc(String(value ?? '—'))}</div>
  </div>`;
}

function placeholderHtml() {
  return `<div class="pdf-placeholder" id="pdf-placeholder">
    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
      <polyline points="14 2 14 8 20 8"/>
    </svg>
    <p>Select an invoice to view the original document.</p>
  </div>`;
}
function noSelectionHtml() {
  return `<div class="no-selection">
    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
    </svg>
    <h3>No invoice selected</h3>
    <p>Choose an invoice from the sidebar to see<br>extracted data, matched POs, and discrepancies.</p>
  </div>`;
}
function spinnerHtml(msg) {
  return `<div class="spinner"><div class="spin-ring"></div><span>${msg}</span></div>`;
}
function errorHtml(msg) {
  return `<div class="spinner" style="color:var(--err)">${msg}</div>`;
}

// ════════════════════════════════════════════════════════════════════════════
// Formatting
// ════════════════════════════════════════════════════════════════════════════
function esc(s) {
  if (s == null) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function fmt(n) {
  if (n == null) return '—';
  return Number(n).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function fmtMoney(currency, n) {
  if (n == null) return null;
  return `${currency || ''} ${fmt(n)}`.trim();
}
function fmtDate(iso) {
  if (!iso) return '';
  try {
    return new Date(iso).toLocaleString(undefined, {
      day: '2-digit', month: 'short', year: 'numeric',
      hour: '2-digit', minute: '2-digit',
    });
  } catch { return iso; }
}

function formatMatchDetail(ms) {
  if (!ms) return '';
  
  const methodLabels = {
    'abn_exact': 'ABN Exact',
    'name_exact': 'Name Exact',
    'name_fuzzy': 'Name Fuzzy',
    'email_domain': 'Email Domain',
    'operator_override': 'Manual'
  };
  
  const method = methodLabels[ms.match_method] || ms.match_method || 'Unknown';
  const confidence = ms.confidence != null ? Math.round(ms.confidence * 100) : null;
  const matchedOn = ms.matched_on;
  
  // Build the detail string
  let detail = method;
  
  // Add what was matched on (before confidence for fuzzy matches)
  if (matchedOn) {
    const fieldLabels = {
      'abn': 'ABN',
      'name': 'Name',
      'email_domain': 'Domain'
    };
    const field = fieldLabels[matchedOn.field] || matchedOn.field;
    detail += ` · ${field}`;
    
    // For fuzzy matches, show the fuzzy score instead of confidence
    if (matchedOn.fuzzy_score != null) {
      detail += ` ${Math.round(matchedOn.fuzzy_score * 100)}%`;
      return detail; // Don't add confidence for fuzzy (already shown)
    }
  }
  
  // Add confidence for non-fuzzy matches
  if (confidence != null) {
    detail += ` (${confidence}%)`;
  }
  
  return detail;
}
function setText(id, val) {
  const el = document.getElementById(id);
  if (el) el.textContent = val;
}

// ════════════════════════════════════════════════════════════════════════════
// Edit mode — corrections helpers
// ════════════════════════════════════════════════════════════════════════════

/**
 * Merge operator corrections onto extracted data for display.
 * Returns { inv, sup, corr } where inv/sup reflect corrections.
 */
function mergeCorrections(result) {
  const corr = result.corrections || {};
  const inv  = Object.assign({}, result.extracted_invoice || {});
  const sup  = Object.assign({}, inv.supplier || {});

  // Scalar invoice fields
  ['invoice_number','invoice_date','due_date','po_number',
   'currency','subtotal','tax_amount','total'].forEach(k => {
    if (corr[k] !== undefined) inv[k] = corr[k];
  });

  // Supplier fields
  if (corr.supplier_name    !== undefined) sup.name    = corr.supplier_name;
  if (corr.supplier_abn     !== undefined) sup.abn     = corr.supplier_abn;
  if (corr.supplier_email   !== undefined) sup.email   = corr.supplier_email;
  if (corr.supplier_phone   !== undefined) sup.phone   = corr.supplier_phone;
  if (corr.supplier_address !== undefined) sup.address = corr.supplier_address;

  // Line items (full replacement)
  if (corr.line_items !== undefined) inv.line_items = corr.line_items;

  // Custom fields (full replacement)
  if (corr.custom_fields !== undefined) inv.custom_fields = corr.custom_fields;

  inv.supplier = sup;
  return { inv, sup, corr };
}

// ════════════════════════════════════════════════════════════════════════════
// Edit mode — enter / exit / save
// ════════════════════════════════════════════════════════════════════════════

function startEdit(result) {
  if (!result) return;
  S.editing = true;
  const { inv } = mergeCorrections(result);
  // Deep-copy line items so we don't mutate the stored result
  S.editLineItems = JSON.parse(JSON.stringify(inv.line_items || []));
  renderEditData(result);
}

function cancelEdit() {
  S.editing = false;
  _lookupSupplierId = null;
  renderData(S.currentResult);
}

async function saveEdit(stem) {
  syncEditLineItemsFromDOM();

  const result  = S.currentResult;
  const rawInv  = result.extracted_invoice || {};   // original extraction (no corrections)
  const rawSup  = rawInv.supplier || {};
  const corr    = {};   // only fields that actually changed

  const getVal = id => { const el = document.getElementById(id); return el ? el.value.trim() : undefined; };
  const getNum = id => {
    const el = document.getElementById(id);
    if (!el || el.value.trim() === '') return null;
    const n = parseFloat(el.value.replace(/,/g, ''));
    return isNaN(n) ? null : n;
  };

  // Only add to corr when the new value differs from the raw original
  const diffStr = (corrKey, newVal, origVal) => {
    const o = origVal != null ? String(origVal).trim() : '';
    const n = newVal  != null ? String(newVal).trim()  : '';
    if (n !== o) corr[corrKey] = newVal;
  };
  const diffNum = (corrKey, newVal, origVal) => {
    const o = origVal != null ? Number(origVal) : null;
    const n = newVal  != null ? Number(newVal)  : null;
    if (n !== o) corr[corrKey] = newVal;
  };

  diffStr('invoice_number',   getVal('edit-invoice_number'),   rawInv.invoice_number);
  diffStr('invoice_date',     getVal('edit-invoice_date'),     rawInv.invoice_date);
  diffStr('due_date',         getVal('edit-due_date'),         rawInv.due_date);
  diffStr('po_number',        getVal('edit-po_number'),        rawInv.po_number);
  diffStr('currency',         getVal('edit-currency'),         rawInv.currency);
  diffNum('subtotal',         getNum('edit-subtotal'),         rawInv.subtotal);
  diffNum('tax_amount',       getNum('edit-tax_amount'),       rawInv.tax_amount);
  diffNum('total',            getNum('edit-total'),            rawInv.total);
  diffStr('supplier_name',    getVal('edit-supplier_name'),    rawSup.name);
  diffStr('supplier_abn',     getVal('edit-supplier_abn'),     rawSup.abn);
  diffStr('supplier_email',   getVal('edit-supplier_email'),   rawSup.email);
  diffStr('supplier_phone',   getVal('edit-supplier_phone'),   rawSup.phone);
  diffStr('supplier_address', getVal('edit-supplier_address'), rawSup.address);

  // If operator used the lookup button or manually changed the supplier ID field,
  // persist the chosen supplier_id so the export JSON carries the correct ID.
  const origSupplierId = (result.matched_supplier || {}).supplier_id || null;
  const manualSupplierId = getVal('edit-supplier_id');
  if (_lookupSupplierId !== null && _lookupSupplierId !== origSupplierId) {
    corr.corrected_supplier_id = _lookupSupplierId;
  } else if (manualSupplierId && manualSupplierId !== origSupplierId) {
    corr.corrected_supplier_id = manualSupplierId;
  }

  // Line items — only save if they actually changed vs. the raw original
  const rawItems = JSON.stringify(rawInv.line_items || []);
  const newItems = JSON.stringify(S.editLineItems);
  if (newItems !== rawItems) corr.line_items = S.editLineItems;

  // Custom fields — save entire dict if any value changed
  const rawCF = rawInv.custom_fields || {};
  const cfKeys = Object.keys(rawCF);
  if (cfKeys.length) {
    let cfChanged = false;
    const newCF = {};
    cfKeys.forEach(k => {
      const el = document.getElementById(`edit-cf-${k}`);
      const newVal = el ? el.value.trim() : String(rawCF[k] ?? '').trim();
      newCF[k] = newVal;
      if (newVal !== String(rawCF[k] ?? '').trim()) cfChanged = true;
    });
    if (cfChanged) corr.custom_fields = newCF;
  }

  S.editing = false;
  try {
    await api.saveCorrections(stem, corr);
    _lookupSupplierId = null;
    // Re-fetch to get the DB-persisted corrections
    const [updated, pages] = await Promise.all([api.detail(stem), api.pages(stem)]);
    renderPdf(updated, pages);
    renderData(updated);
  } catch (e) {
    S.editing = true;
    alert('Failed to save corrections: ' + e.message);
  }
}

// ════════════════════════════════════════════════════════════════════════════
// Edit mode — line item helpers
// ════════════════════════════════════════════════════════════════════════════

/** Sync current DOM inputs back into S.editLineItems before mutating the array */
function syncEditLineItemsFromDOM() {
  const rows = document.querySelectorAll('#edit-li-tbody tr');
  const items = [];
  rows.forEach((tr, idx) => {
    const get = cls => { const el = tr.querySelector('.' + cls); return el ? el.value.trim() : ''; };
    const description = get('eli-desc');
    const sku         = get('eli-sku');
    const qtyStr      = get('eli-qty');
    const upStr       = get('eli-up');
    const totStr      = get('eli-tot');
    const qty  = qtyStr  !== '' ? parseFloat(qtyStr.replace(/,/g, ''))  : null;
    const up   = upStr   !== '' ? parseFloat(upStr.replace(/,/g, ''))   : null;
    const tot  = totStr  !== '' ? parseFloat(totStr.replace(/,/g, ''))  : null;

    const item = { line_number: idx + 1 };
    if (description) item.description = description;
    if (sku)         item.sku         = sku;
    if (qty  != null && !isNaN(qty)) item.quantity   = qty;
    if (up   != null && !isNaN(up))  item.unit_price = up;
    if (tot  != null && !isNaN(tot)) item.line_total = tot;

    // Only keep rows that have at least a description or a total
    if (description || (tot != null && !isNaN(tot))) items.push(item);
  });
  S.editLineItems = items;
}

function addLineItem() {
  syncEditLineItemsFromDOM();
  S.editLineItems.push({ line_number: S.editLineItems.length + 1 });
  renderEditLineItems();
  // Focus the description field of the new row
  const tbody = document.getElementById('edit-li-tbody');
  if (tbody) {
    const lastRow = tbody.lastElementChild;
    if (lastRow) { const el = lastRow.querySelector('.eli-desc'); if (el) el.focus(); }
  }
}

function removeLineItem(idx) {
  syncEditLineItemsFromDOM();
  S.editLineItems.splice(idx, 1);
  renderEditLineItems();
}

function renderEditLineItems() {
  const tbody = document.getElementById('edit-li-tbody');
  if (tbody) {
    tbody.innerHTML = editLineItemRowsHtml();
    highlightSelectedRow();
  }
  const cntEl = document.getElementById('edit-li-count');
  if (cntEl) cntEl.textContent = S.editLineItems.length;
}

function editLineItemRowsHtml() {
  if (!S.editLineItems.length) {
    return `<tr><td colspan="6" style="padding:12px;text-align:center;color:var(--muted);font-style:italic">No line items — click "+ Add Line Item" to add one.</td></tr>`;
  }
  return S.editLineItems.map((item, idx) => `<tr>
    <td><input class="edit-input eli-sku"  value="${esc(item.sku||'')}"  placeholder="SKU" style="min-width:70px"></td>
    <td><input class="edit-input eli-desc" value="${esc(item.description||'')}" placeholder="Description" style="min-width:160px"></td>
    <td><input class="edit-input eli-qty"  value="${item.quantity   != null ? item.quantity   : ''}" placeholder="0"    style="width:60px"></td>
    <td><input class="edit-input eli-up"   value="${item.unit_price != null ? item.unit_price : ''}" placeholder="0.00" style="width:80px"></td>
    <td><input class="edit-input eli-tot"  value="${item.line_total != null ? item.line_total : ''}" placeholder="0.00" style="width:80px"></td>
    <td><button class="btn-row-del" onclick="removeLineItem(${idx})" title="Remove row">×</button></td>
  </tr>`).join('');
}

// ════════════════════════════════════════════════════════════════════════════
// Edit mode — full edit panel renderer
// ════════════════════════════════════════════════════════════════════════════

function renderEditData(result) {
  _lookupSupplierId = null;   // clear on each new edit session
  const { inv, sup } = mergeCorrections(result);
  const ms = result.matched_supplier || null;
  const stem = result.stem || '';

  document.getElementById('data-panel').innerHTML = `
    <div class="action-bar">
      <div class="status-pill ${result.status || 'needs_review'}">
        <div class="status-pill-dot"></div>
        ✎ Editing
      </div>
      <div class="action-btns">
        <button class="btn btn-cancel-edit" onclick="cancelEdit()">Cancel</button>
        <button class="btn btn-save-edit" onclick="saveEdit('${esc(stem)}')">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
          Save Changes
        </button>
      </div>
    </div>

    <div class="edit-mode-notice">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
      Editing extracted data. Changes are saved as corrections — the original extraction is preserved.
    </div>

    <!-- Invoice Details edit -->
    <div class="card">
      <div class="card-header">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
          <line x1="1" y1="10" x2="23" y2="10"/>
        </svg>
        Invoice Details
      </div>
      <div class="kv-grid">
        ${kvE('Invoice Number', 'edit-invoice_number', inv.invoice_number)}
        ${kvE('Invoice Date',   'edit-invoice_date',   inv.invoice_date)}
        ${kvE('Due Date',       'edit-due_date',        inv.due_date)}
        ${kvE('PO Number',      'edit-po_number',       inv.po_number)}
        ${kvE('Currency',       'edit-currency',        inv.currency)}
        ${kvE('Subtotal',       'edit-subtotal',        inv.subtotal   != null ? inv.subtotal   : '')}
        ${kvE('Tax',            'edit-tax_amount',      inv.tax_amount != null ? inv.tax_amount : '')}
        ${kvE('Total',          'edit-total',           inv.total      != null ? inv.total      : '')}
      </div>
    </div>

    <!-- Supplier edit -->
    <div class="card">
      <div class="card-header">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 7H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
          <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
        </svg>
        Supplier
        <button class="btn-lookup" onclick="openSupplierLookup()" title="Lookup supplier from database">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
          </svg>
          Lookup
        </button>
        ${S.config && S.config.allow_create_supplier ? `
        <button class="btn-lookup" onclick="openCreateSupplierModal()" title="Create new supplier from current details" style="margin-left:4px">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"/>
            <line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
          Create
        </button>` : ''}
      </div>
      <div class="kv-grid">
        ${kvE('Supplier ID',  'edit-supplier_id',      _lookupSupplierId || (ms && ms.supplier_id) || '', true)}
        ${kvE('Name',         'edit-supplier_name',    sup.name)}
        ${kvE('ABN / Tax ID', 'edit-supplier_abn',     sup.abn)}
        ${kvE('Email',        'edit-supplier_email',   sup.email)}
        ${kvE('Phone',        'edit-supplier_phone',   sup.phone)}
        ${kvEWide('Address',  'edit-supplier_address', sup.address)}
      </div>
    </div>

    <!-- Line items edit -->
    <div class="card">
      <div class="card-header">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/>
          <line x1="8" y1="18" x2="21" y2="18"/>
          <line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/>
          <line x1="3" y1="18" x2="3.01" y2="18"/>
        </svg>
        Line Items
        <span class="badge info" id="edit-li-count">${S.editLineItems.length}</span>
        ${inv.po_number ? `<button class="btn-po-lookup" onclick="openPOLinesPanel('${esc(inv.po_number)}')" title="View PO lines for ${esc(inv.po_number)}">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
            <line x1="10" y1="9" x2="8" y2="9"/>
          </svg>
          PO Lookup
        </button>` : ''}
      </div>
      <div class="card-scroll" style="max-height:380px">
        <table class="edit-li-table">
          <thead><tr>
            <th>SKU</th><th>Description</th><th>Qty</th>
            <th>Unit Price</th><th>Total</th><th></th>
          </tr></thead>
          <tbody id="edit-li-tbody">${editLineItemRowsHtml()}</tbody>
        </table>
      </div>
      <button class="btn-add-row" onclick="addLineItem()">+ Add Line Item</button>
    </div>

    ${customFieldsEditCard(inv)}
    ${notesCard(result)}
    <div style="height:10px"></div>
  `;
}

function customFieldsEditCard(inv) {
  const cf = inv.custom_fields || {};
  const entries = Object.entries(cf);
  if (!entries.length) return '';
  const title = inv.custom_fields_title || 'Custom Fields';
  const items = entries.map(([k, v]) => {
    const label = k.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    return kvE(label, `edit-cf-${esc(k)}`, v);
  }).join('');
  return `<div class="card">
    <div class="card-header">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
      ${esc(title)}
    </div>
    <div class="kv-grid">${items}</div>
  </div>`;
}

// Edit-mode kv helpers (input fields instead of read-only values)
function kvE(label, id, value, readOnly=false) {
  const roAttr = readOnly ? 'readonly style="background:var(--bg);color:var(--muted)"' : '';
  return `<div class="kv-item">
    <div class="kv-label">${esc(label)}</div>
    <input id="${id}" class="edit-input" value="${esc(String(value ?? ''))}" ${roAttr}>
  </div>`;
}
function kvEWide(label, id, value) {
  return `<div class="kv-item" style="grid-column:1/-1;border-right:none">
    <div class="kv-label">${esc(label)}</div>
    <input id="${id}" class="edit-input" value="${esc(String(value ?? ''))}">
  </div>`;
}

// ════════════════════════════════════════════════════════════════════════════
// Tablet: sidebar drawer
// ════════════════════════════════════════════════════════════════════════════
function isTablet() { return window.innerWidth <= 900; }

function openSidebar() {
  document.querySelector('aside').classList.add('drawer-open');
  document.getElementById('sidebar-overlay').classList.add('visible');
}
function closeSidebar() {
  document.querySelector('aside').classList.remove('drawer-open');
  document.getElementById('sidebar-overlay').classList.remove('visible');
}
function toggleSidebar() {
  const open = document.querySelector('aside').classList.contains('drawer-open');
  open ? closeSidebar() : openSidebar();
}

// ════════════════════════════════════════════════════════════════════════════
// Tablet: panel toggle (PDF ↔ Data)
// ════════════════════════════════════════════════════════════════════════════
function setPanel(name) {
  const pdfPanel  = document.getElementById('pdf-panel');
  const datPanel  = document.getElementById('data-panel');
  const tabPdf    = document.getElementById('tab-pdf');
  const tabDat    = document.getElementById('tab-data');
  if (name === 'pdf') {
    pdfPanel.classList.add('panel-active');
    datPanel.classList.remove('panel-active');
    tabPdf.classList.add('active');
    tabDat.classList.remove('active');
  } else {
    datPanel.classList.add('panel-active');
    pdfPanel.classList.remove('panel-active');
    tabDat.classList.add('active');
    tabPdf.classList.remove('active');
  }
}

// ════════════════════════════════════════════════════════════════════════════
// Panel resizer
// ════════════════════════════════════════════════════════════════════════════
(function () {
  const STORAGE_KEY = 'pdf-panel-width';
  const resizer  = document.getElementById('panel-resizer');
  const pdfPanel = document.getElementById('pdf-panel');
  const main     = resizer.closest('main');

  // Restore saved width
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) pdfPanel.style.width = saved;

  // Restore saved zoom
  const savedZoom = parseInt(localStorage.getItem('pdf-zoom'), 10);
  if (!isNaN(savedZoom)) S.pdfZoom = Math.min(200, Math.max(50, savedZoom));

  let startX, startW;

  resizer.addEventListener('mousedown', e => {
    e.preventDefault();
    startX = e.clientX;
    startW = pdfPanel.getBoundingClientRect().width;
    resizer.classList.add('dragging');
    document.body.style.cursor    = 'col-resize';
    document.body.style.userSelect = 'none';
  });

  document.addEventListener('mousemove', e => {
    if (!resizer.classList.contains('dragging')) return;
    const mainW  = main.getBoundingClientRect().width;
    const delta  = e.clientX - startX;
    const newPct = Math.min(75, Math.max(15, ((startW + delta) / mainW) * 100));
    pdfPanel.style.width = newPct + '%';
  });

  document.addEventListener('mouseup', () => {
    if (!resizer.classList.contains('dragging')) return;
    resizer.classList.remove('dragging');
    document.body.style.cursor     = '';
    document.body.style.userSelect = '';
    localStorage.setItem(STORAGE_KEY, pdfPanel.style.width);
  });
})();

// ════════════════════════════════════════════════════════════════════════════
// PDF pan (drag-to-scroll) + shift-wheel horizontal scroll + ctrl-wheel zoom
// ════════════════════════════════════════════════════════════════════════════
(function() {
  const panel = document.getElementById('pdf-panel');
  
  // Shift+scroll → horizontal pan
  // Ctrl+scroll → zoom in/out
  panel.addEventListener('wheel', e => {
    if (e.shiftKey) {
      e.preventDefault();
      panel.scrollLeft += e.deltaY;
    } else if (e.ctrlKey || e.metaKey) {
      e.preventDefault();
      // Zoom: negative deltaY = scroll up = zoom in, positive = zoom out
      const zoomDelta = e.deltaY > 0 ? -0.1 : 0.1;
      updateZoom(zoomDelta);
    }
  }, { passive: false });
})();

// ════════════════════════════════════════════════════════════════════════════
// Upload Invoice
// ════════════════════════════════════════════════════════════════════════════

function triggerUpload() {
  document.getElementById('upload-input').click();
}

async function handleUpload(input) {
  const file = input.files[0];
  if (!file) return;

  const btn   = document.getElementById('upload-btn');
  const label = document.getElementById('upload-btn-label');

  btn.disabled  = true;
  label.textContent = 'Uploading…';

  try {
    const fd = new FormData();
    fd.append('file', file);

    const resp = await fetch('/api/upload', { method: 'POST', body: fd });
    const data = await resp.json();
    if (!resp.ok) throw new Error(data.detail || `HTTP ${resp.status}`);

    showToast(`✓ "${data.filename}" uploaded — the pipeline will process it shortly`, 'success');

    // Refresh the list so the invoice appears once the pipeline picks it up
    setTimeout(() => poll(), 3000);

  } catch (e) {
    showToast(`Upload failed: ${e.message}`, 'error');
  } finally {
    btn.disabled        = false;
    label.textContent   = 'Upload Invoice';
    input.value         = '';   // allow re-selecting the same file
  }
}

// ════════════════════════════════════════════════════════════════════════════
// Toast notifications
// ════════════════════════════════════════════════════════════════════════════

function showToast(message, type = 'info', durationMs = 5000) {
  const container = document.getElementById('toast-container');
  const icons = { success: '✓', error: '✕', info: 'ℹ' };

  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `<span class="toast-icon">${icons[type] ?? 'ℹ'}</span><span class="toast-body">${esc(message)}</span>`;

  container.appendChild(toast);

  // Auto-dismiss
  setTimeout(() => {
    toast.style.transition = 'opacity .3s, transform .3s';
    toast.style.opacity    = '0';
    toast.style.transform  = 'translateY(8px)';
    setTimeout(() => toast.remove(), 320);
  }, durationMs);
}

// ════════════════════════════════════════════════════════════════════════════
// Theme / Dark Mode
// ════════════════════════════════════════════════════════════════════════════
function initTheme() {
  // Check for saved preference
  const saved = localStorage.getItem('theme');
  if (saved) {
    document.documentElement.setAttribute('data-theme', saved);
  } else {
    // Check system preference
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (prefersDark) {
      document.documentElement.setAttribute('data-theme', 'dark');
    }
  }
}

function toggleTheme() {
  const current = document.documentElement.getAttribute('data-theme');
  const next = current === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
}

// Initialize theme immediately to prevent flash
initTheme();

// ════════════════════════════════════════════════════════════════════════════
// Auth — show logout button when a session is active
// ════════════════════════════════════════════════════════════════════════════
(async function initAuth() {
  try {
    const r = await fetch('/api/auth/me').then(r => r.json());
    S.config = r.config || {};
    if (r.user) {
      const form = document.getElementById('logout-form');
      document.getElementById('logout-label').textContent = `${r.user.username} · Sign out`;
      form.style.display = '';
    }
  } catch (_) {}
})();

// ════════════════════════════════════════════════════════════════════════════
// Keyboard shortcuts
// ════════════════════════════════════════════════════════════════════════════

document.addEventListener('keydown', e => {
  // Ignore if in an input/textarea (except for / and ? which work anywhere)
  const target = e.target;
  const isInput = target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable;
  
  // ? - Show keyboard shortcuts help (works anywhere)
  if (e.key === '?' && !e.ctrlKey && !e.metaKey && !e.altKey) {
    e.preventDefault();
    showShortcutsHelp();
    return;
  }
  
  // / - Focus search (works anywhere)
  if (e.key === '/' && !e.ctrlKey && !e.metaKey && !e.altKey) {
    e.preventDefault();
    document.getElementById('search-input')?.focus();
    showToast('Search focused', 'info', 1500);
    return;
  }
  
  // Ignore other shortcuts if in an input
  if (isInput) return;
  
  // Don't intercept if modal is open
  const modalOpen = document.querySelector('.modal-overlay:not(.hidden)') || 
                    document.getElementById('supplier-modal') ||
                    document.getElementById('create-supplier-modal');
  if (modalOpen) return;
  
  const stem = S.selected;
  
  switch (e.key.toLowerCase()) {
    case 'e':
      // Edit mode
      if (stem && !S.editing && S.currentResult?.status !== 'exported') {
        e.preventDefault();
        startEdit(S.currentResult);
        showToast('Edit mode', 'info', 1500);
      }
      break;
      
    case 's':
      // Mark as Ready
      if (stem && !S.editing && S.currentResult?.status !== 'exported') {
        e.preventDefault();
        clearFlag(stem);
        showToast('Marked as Ready', 'success', 1500);
      }
      break;
      
    case 'f':
      // Flag for review (needs_review)
      if (stem && !S.editing && S.currentResult?.status !== 'exported') {
        e.preventDefault();
        flagInvoice(stem);
        showToast('Flagged for review', 'warning', 1500);
      }
      break;
      
    case 'x':
      // Export
      if (stem && !S.editing && S.currentResult?.status === 'ready') {
        e.preventDefault();
        exportInvoice(stem);
        // Toast shown by exportInvoice function
      }
      break;
      
    case 'r':
      // Reprocess
      if (stem && !S.editing && S.currentResult?.status !== 'exported') {
        e.preventDefault();
        if (confirm('Reprocess this invoice? All corrections will be lost.')) {
          reprocessInvoice(stem);
        }
      }
      break;
      
    case 'n':
      // Focus notes field
      if (stem && !S.editing) {
        e.preventDefault();
        document.getElementById('notes-textarea')?.focus();
        showToast('Notes focused', 'info', 1500);
      }
      break;
      
    case 'escape':
      // Exit edit mode or close panels
      if (S.editing) {
        e.preventDefault();
        cancelEdit();
        showToast('Edit cancelled', 'info', 1500);
      }
      break;
  }
});

function showShortcutsHelp() {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.id = 'shortcuts-help-modal';
  modal.innerHTML = `
    <div class="modal-dialog" style="max-width:480px">
      <div class="modal-header">
        <span style="font-weight:600;font-size:14px">⌨️ Keyboard Shortcuts</span>
        <button class="btn-sm" onclick="document.getElementById('shortcuts-help-modal').remove()" style="margin-left:auto">✕</button>
      </div>
      <div class="modal-body" style="padding:16px">
        <div style="display:grid;grid-template-columns:auto 1fr;gap:12px 24px;font-size:13px;line-height:1.6">
          <div style="font-weight:600;color:var(--accent)">Navigation</div><div></div>
          <kbd>↑</kbd> <div>Previous invoice</div>
          <kbd>↓</kbd> <div>Next invoice</div>
          <kbd>Enter</kbd> <div>Select invoice</div>
          <kbd>/</kbd> <div>Focus search</div>
          
          <div style="font-weight:600;color:var(--accent);margin-top:8px">Actions</div><div></div>
          <kbd>e</kbd> <div>Edit mode</div>
          <kbd>s</kbd> <div>Mark as Ready</div>
          <kbd>f</kbd> <div>Flag for review</div>
          <kbd>x</kbd> <div>Export invoice</div>
          <kbd>r</kbd> <div>Reprocess</div>
          <kbd>n</kbd> <div>Focus notes field</div>
          <kbd>Esc</kbd> <div>Cancel edit / close</div>
          
          <div style="font-weight:600;color:var(--accent);margin-top:8px">PDF Viewer</div><div></div>
          <kbd>Ctrl + Scroll</kbd> <div>Zoom in/out</div>
          <kbd>Shift + Scroll</kbd> <div>Horizontal scroll</div>
          
          <div style="font-weight:600;color:var(--accent);margin-top:8px">Help</div><div></div>
          <kbd>?</kbd> <div>Show this help</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="document.getElementById('shortcuts-help-modal').remove()">Close</button>
      </div>
    </div>
  `;
  modal.onclick = e => { if (e.target === modal) modal.remove(); };
  document.body.appendChild(modal);
}

// ════════════════════════════════════════════════════════════════════════════
// Boot
// ════════════════════════════════════════════════════════════════════════════

// Fetch build commit from API and update header
async function loadBuildInfo() {
  try {
    const settings = await api.get('/api/admin/settings');
    const commit = settings?.build?.commit;
    // Only update if we got a real commit hash (not 'unknown' or empty)
    if (commit && commit !== 'unknown' && commit.length >= 7) {
      const buildTag = document.querySelector('.build-tag');
      if (buildTag) {
        buildTag.textContent = 'build ' + commit;
      }
    }
  } catch (e) {
    // Silently fail - keep hardcoded build tag
    console.debug('Could not load build info:', e.message);
  }
}

loadBuildInfo();
poll();
setInterval(poll, 6000);
</script>
</body>
</html>
